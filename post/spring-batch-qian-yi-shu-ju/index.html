<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Spring Batch è¿ç§»æ•°æ® | ç©ºè°ƒæˆ¿</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://jiangjinxinn.github.io//favicon.ico?v=1586223278037">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://jiangjinxinn.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://jiangjinxinn.github.io/">
        <img src="https://jiangjinxinn.github.io//images/avatar.png?v=1586223278037" class="site-logo">
        <h1 class="site-title">ç©ºè°ƒæˆ¿</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      Made with ğŸ¸by jiangjinxinn | <a class="rss" href="https://jiangjinxinn.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Spring Batch è¿ç§»æ•°æ®</h2>
            <div class="post-date">2019-10-04</div>
            
            <div class="post-content">
              <p>èƒŒæ™¯ï¼š<br>
åŸƒæ£®å“²å’Œ spring åˆä½œï¼Œä¸»è¦æ¥è‡ªåŸƒæ£®å“²çš„ç§¯ç´¯ï¼Œéšå JSR-352 è§„èŒƒ<br>
æ ¸å¿ƒåœ¨äºé¢†åŸŸæ¨¡å‹</p>
<p>ç›¸å…³èµ„æ–™:</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1456757">Spring Batch(1)â€”â€”æ•°æ®æ‰¹å¤„ç†æ¦‚å¿µ                                                                            - äº‘+ç¤¾åŒº - è…¾è®¯äº‘</a></li>
<li>https://docs.spring.io/spring-batch/4.2.x/reference/html/index.html</li>
<li>https://github.com/spring-projects/spring-batch/tree/master/spring-batch-samples</li>
<li>https://github.com/jxtaliu/SpringBatchSample</li>
</ul>
<p>é¢†åŸŸæ¨¡å‹:<br>
JobLanuncherã€jobã€jobInstance<br>
flow<br>
step<br>
tasklet (ç»†åŒ–å°ä»»åŠ¡ï¼‰<br>
chunk<br>
itemReader<br>
process<br>
itemWriter</p>
<p>ä¸€äº›é—®é¢˜:<br>
ä¸è¦æŠŠ jpa reader writer æ³¨å†Œä¸º beanï¼Œæ³¨é”€ bean çš„æ—¶å€™ä¼š close EntityManager ä¸¤éï¼ˆè¿™ä¸ªæ²¡æ·±ç©¶ï¼Œè§£å†³äº†é—®é¢˜æˆ‘å°±æºœäº†ï¼‰</p>
<p>ä»»åŠ¡ restart<br>
restart, é»˜è®¤å¤±è´¥çš„ä»»åŠ¡ä¸‹æ¬¡å¯åŠ¨ä¼šï¼Œé‡æ–°æ‰§è¡Œï¼Œæ ¹æ® JobRepository å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œ<br>
å¯ä»¥é€šè¿‡<code>org.springframework.batch.core.job.builder.JobBuilderHelper#preventRestart</code>  è¿›è¡Œå…³é—­<br>
ä¹Ÿå¯ä»¥åœ¨<code>org.springframework.batch.item.support.AbstractItemCountingItemStreamItemReader#setSaveState</code> å¯¹é½å…³é—­</p>
<p>ä»»åŠ¡ä¼šåœ¨ <code>BATCH_STEP_EXECUTION_CONTEXT</code>  è¡¨ä¸­æ·»åŠ è®°å½•æ‰§è¡Œè®°å½•ï¼Œå·² <code>JpaPagingItemReader</code> ä¸ºä¾‹ï¼Œä¼šè®°å½•å½“å‰å·²è¿›è¡Œåˆ°çš„æ•°ç›®count<br>
<code>{&quot;batch.taskletTypetaskletType&quot;:&quot;org.springframework.batch.core.step.item.ChunkOrientedTasklet&quot;,&quot;JpaPagingItemReader.read.count&quot;:428,&quot;batch.stepType&quot;:&quot;org.springframework.batch.core.step.tasklet.TaskletStep&quot;}</code><br>
å¦‚æœå¤±è´¥äº†ï¼Œä¸‹æ¬¡ä¼šä»è®°å½•çš„æ•°ç›®å¤„å¼€å§‹è¯»å–ï¼Œå¤±è´¥ skip æ‰çš„æ•°æ®ï¼Œä¹Ÿä¼šè¢«ç®—åˆ°è¯»å–çš„æ•°æ®ä¸Š</p>
<p>é‡è¯•ï¼Œè·³è¿‡<br>
step æ·»åŠ  backOffPolicy ç­‰å¾…ä¸€æ®µæ—¶é—´</p>
<p>step ä¹‹é—´å¤šçº¿ç¨‹<br>
å¤šä¸ª step å¹¶å‘<br>
è¿œç¨‹åˆ†ç‰‡ï¼Œåˆ†åŒº</p>
<pre><code>package name.ealen.batch;

import name.ealen.config.ExecutorConfiguration;
import name.ealen.listener.JobListener;
import name.ealen.model.Access;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.batch.core.ExitStatus;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.configuration.annotation.JobBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.batch.core.launch.support.RunIdIncrementer;
import org.springframework.batch.item.ItemProcessor;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.batch.item.database.JpaPagingItemReader;
import org.springframework.batch.item.database.orm.JpaNativeQueryProvider;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

import javax.annotation.Resource;
import javax.persistence.EntityManagerFactory;

//**/
/ * Created by EalenXie on 2018/9/10 14:50./
/ * :@EnableBatchProcessingæä¾›ç”¨äºæ„å»ºæ‰¹å¤„ç†ä½œä¸šçš„åŸºæœ¬é…ç½®/
/ *//
@Configuration
@EnableBatchProcessing
public class DataBatchConfiguration {
    private static final Logger /log/= LoggerFactory./getLogger/(DataBatchConfiguration.class);

    @Resource
    private JobBuilderFactory jobBuilderFactory;    //ç”¨äºæ„å»ºJOB

    @Resource
    private StepBuilderFactory stepBuilderFactory;  //ç”¨äºæ„å»ºStep

    @Resource
    private EntityManagerFactory emf;           //æ³¨å…¥å®ä¾‹åŒ–Factory è®¿é—®æ•°æ®

    @Resource
    private JobListener jobListener;            //ç®€å•çš„JOB listener

    @Resource
    private ThreadPoolTaskExecutor threadPoolTaskExecutor;

    //**/
/     * ä¸€ä¸ªç®€å•åŸºç¡€çš„Jobé€šå¸¸ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªStepç»„æˆ/
/     *//
@Bean
    public Job dataHandleJob() {
        return jobBuilderFactory.get(&quot;dataHandleJob&quot;).
                incrementer(new RunIdIncrementer()).
                start(handleDataStep()).    //startæ˜¯JOBæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªstep

//                next(xxxStep()).
//                next(xxxStep()).
//                ...
        listener(jobListener).      //è®¾ç½®äº†ä¸€ä¸ªç®€å•JobListener
                build();
    }

    //**/
/     * ä¸€ä¸ªç®€å•åŸºç¡€çš„Stepä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†/
/     * ItemReader : ç”¨äºè¯»å–æ•°æ®/
/     * ItemProcessor : ç”¨äºå¤„ç†æ•°æ®/
/     * ItemWriter : ç”¨äºå†™æ•°æ®/
/     *//
@Bean
    public Step handleDataStep() {
        return stepBuilderFactory.get(&quot;getData&quot;).
                &lt;Access, Access&gt;chunk(100).        // &lt;è¾“å…¥,è¾“å‡º&gt; ã€‚chunké€šä¿—çš„è®²ç±»ä¼¼äºSQLçš„commit; è¿™é‡Œè¡¨ç¤ºå¤„ç†(processor)100æ¡åå†™å…¥(writer)ä¸€æ¬¡ã€‚
                faultTolerant().retryLimit(3).retry(Exception.class).skipLimit(100).skip(Exception.class).
                listener(new SkipCheckingListener()). //æ•æ‰åˆ°å¼‚å¸¸å°±é‡è¯•,é‡è¯•100æ¬¡è¿˜æ˜¯å¼‚å¸¸,JOBå°±åœæ­¢å¹¶æ ‡å¿—å¤±è´¥
                reader(getDataReader()).         //æŒ‡å®šItemReader
                processor(getDataProcessor()).   //æŒ‡å®šItemProcessor
                writer(getDataWriter()).         //æŒ‡å®šItemWriter
                build();
    }

    public ItemReader&lt;? extends Access&gt; getDataReader() {
        //è¯»å–æ•°æ®,è¿™é‡Œå¯ä»¥ç”¨JPA,JDBC,JMS ç­‰æ–¹å¼ è¯»å…¥æ•°æ®
        JpaPagingItemReader&lt;Access&gt; reader = new JpaPagingItemReader&lt;&gt;();
        //è¿™é‡Œé€‰æ‹©JPAæ–¹å¼è¯»æ•°æ® ä¸€ä¸ªç®€å•çš„ native SQL
        String sqlQuery = â€œSELECT * FROM accessâ€;
        try {
            JpaNativeQueryProvider&lt;Access&gt; queryProvider = new JpaNativeQueryProvider&lt;&gt;();
            queryProvider.setSqlQuery(sqlQuery);
            queryProvider.setEntityClass(Access.class);
            queryProvider.afterPropertiesSet();
            reader.setEntityManagerFactory(emf);
            reader.setPageSize(3);
            reader.setQueryProvider(queryProvider);
            reader.afterPropertiesSet();
            //æ‰€æœ‰ItemReaderå’ŒItemWriterå®ç°éƒ½ä¼šåœ¨ExecutionContextæäº¤ä¹‹å‰å°†å…¶å½“å‰çŠ¶æ€å­˜å‚¨åœ¨å…¶ä¸­,å¦‚æœä¸å¸Œæœ›è¿™æ ·åš,å¯ä»¥è®¾ç½®setSaveState(false)
            reader.setSaveState(true);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return reader;
    }

    public ItemProcessor&lt;Access, Access&gt; getDataProcessor() {
        return new ItemProcessor&lt;Access, Access&gt;() {
            @Override
            public Access process(Access access) throws Exception {
                /log/.info(â€œprocessor data : â€œ + access.toString());  //æ¨¡æ‹Ÿ  å‡è£…å¤„ç†æ•°æ®,è¿™é‡Œå¤„ç†å°±æ˜¯æ‰“å°ä¸€ä¸‹
                return access;
            }
        };
//        lambdaä¹Ÿå¯ä»¥å†™ä¸º:
//        return access -&gt; {
//            log.info(â€œprocessor data : â€œ + access.toString());
//            return access;
//        };
    }

    public ItemWriter&lt;Access&gt; getDataWriter() {
        return list -&gt; {
            for (Access access : list) {
                /log/.info(â€œwrite data : â€œ + access); //æ¨¡æ‹Ÿ å‡è£…å†™æ•°æ® ,è¿™é‡Œå†™çœŸæ­£å†™å…¥æ•°æ®çš„é€»è¾‘
            }
        };
    }


}

</code></pre>
<p>æ —å­ï¼š<br>
è®¾ç½®ä¸¤ä¸ªæ•°æ®æºï¼Œé€šè¿‡ spring batch è¿›è¡Œè·¨æ•°æ®åº“æ•°æ®è¿ç§»ï¼Œé€šè¿‡ JpaPagingItemReader è¿›è¡Œè¯»å–æ•°æ®ï¼Œç”¨ jdbcTemplate è¿›è¡Œæ•°æ®å†™å…¥ï¼Œ<br>
å†å®ç° <code>org.springframework.batch.core.SkipListener</code> æ¥å£è®°å½•è·³è¿‡çš„æ•°æ®ï¼Œç¨åäººå·¥å¤„ç†ï¼Œè¿›è¡Œæ¯”å¯¹å¤„ç†</p>

            </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jiangjinxinn.github.io/post/hello-gridea/">
                  <h3 class="post-title">
                    Hello Gridea
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
