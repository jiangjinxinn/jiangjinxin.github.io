<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Netty å¢å¼ºå†™ | ç©ºè°ƒæˆ¿</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://jiangjinxinn.github.io//favicon.ico?v=1580970894551">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://jiangjinxinn.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://jiangjinxinn.github.io/">
        <img src="https://jiangjinxinn.github.io//images/avatar.png?v=1580970894551" class="site-logo">
        <h1 class="site-title">ç©ºè°ƒæˆ¿</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      Made with ğŸ¸by jiangjinxin | <a class="rss" href="https://jiangjinxinn.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Netty å¢å¼ºå†™</h2>
            <div class="post-date">2020-02-06</div>
            
            <div class="post-content">
              <p>å¦‚æœè¿½æ±‚ååé‡ï¼Œå¯ä»¥ä¸ç”¨ ctx.writeAndFlush()ï¼Œè¿™ç§å†™æ•°æ®æ˜¯åœ¨æ¯æ¬¡ write åéƒ½ç«‹å³ flushï¼ŒåŠ æ€¥å†™æ•°æ®ã€‚</p>
<p>åœ¨ FlushConsolidationHandler ç±»çš„æ³¨é‡Šä¸Šæœ‰è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼š<br>
Flush operations are generally speaking expensive as these may trigger a syscall on the transport level. Thus it is in most cases (where write latency can be traded with throughput) a good idea to try to minimize flush operations as much as possible.</p>
<p>ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªå¢å¼ºå†™çš„ Netty çš„ FlushConsolidationHandleræ¥å¤„ç†è¿™ä¸ªäº‹æƒ…ï¼Œè¿™ä¸ª Handler æœ‰ä¸€ä¸ªå‚æ•° explicitFlushAfterFlushes å¯ä»¥æ§åˆ¶æ‹¦æˆªå‡ æ¬¡ flush åæ‰è¿›è¡ŒçœŸæ­£çš„ flushæ“ä½œã€‚</p>
<p>è¿™é‡Œæåˆ° FlushConsolidationHandler å¯ä»¥æ‹¦æˆªï¼Œé‚£ä¹ˆä¸ç”¨æƒ³ï¼Œè‚¯å®šæ˜¯ç»§æ‰¿äº† ChannelDuplexHandlerã€‚</p>
<p>è¿™é‡Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æ·»åŠ  FlushConsolidationHandler è®¾å®šäº† explicitFlushAfterFlushes ä¹‹åçœ‹ï¼Œå¦‚æœ flush æ¬¡æ•°ä¸å¤Ÿéš¾é“å°±ä¸€ç›´ä¸ flush å‡ºå»äº†ï¼Œéœ€è¦ç­‰åˆ°åè¾¹ä¸€æ¬¡è¯·æ±‚è¿›æ¥çš„å‡ºç«™äº‹ä»¶åˆ°æ¥å flush å¤Ÿäº†æ‰èƒ½å†™å—ï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜è‚¯å®šä¸æ˜¯çš„ï¼Œå¦‚æœæ˜¯çš„è¯å°±æ˜¯ä¸ªä¸¥é‡çš„ç¼ºé™·çš„ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ FlushConsolidationHandler æºç æ¥è¯´æ˜ä¸‹</p>
<p>å…³é”®ç‚¹åœ¨ flush æ–¹æ³•ä¸Šï¼Œéœ€è¦è¯´æ˜çš„æ˜¯åœ¨ä»»æ„ä¸€ä¸ª ctx ä¸Šæ‰§è¡Œ flush çš„æ—¶å€™ï¼Œä¼šæ ¹æ® pipeline ä¸Šè®¾ç½®çš„ ChannelHandlerContextï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ª outBoundHandler ä¼ é€’ä¸‹å»ï¼Œåˆ° FlushConsolidationHandler æ—¶å€™å°±ä¼šè¢«æ‹¦æˆªä¸‹æ¥</p>
<p>@Override<br>
public void flush(ChannelHandlerContext ctx) throws Exception {<br>
if (readInProgress) {<br>
// If there is still a read in progress we are sure we will see a channelReadComplete(...) call. Thus<br>
// we only need to flush if we reach the explicitFlushAfterFlushes limit.<br>
if (++flushPendingCount == explicitFlushAfterFlushes) {<br>
flushNow(ctx);<br>
}<br>
} else if (consolidateWhenNoReadInProgress) {<br>
// Flush immediately if we reach the threshold, otherwise schedule<br>
if (++flushPendingCount == explicitFlushAfterFlushes) {<br>
flushNow(ctx);<br>
} else {<br>
scheduleFlush(ctx);<br>
}<br>
} else {<br>
// Always flush directly<br>
flushNow(ctx);<br>
}<br>
}<br>
Netty æºç ä¸Šçš„æ³¨è§£å·²ç»å¾ˆå¥½çš„è¯´æ˜äº†ï¼Œæœ‰ä¸€ä¸ªå˜é‡ readInProgress æ ‡è¯†æ˜¯å¦æ­£åœ¨è¯»ï¼ˆå³è¯»äº‹ä»¶æœªç»“æŸï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸æŸ¥çœ‹ consolidateWhenNoReadInProgress è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æœ readInProgress æ ‡è®°æ­£åœ¨è¯» FlushConsolidationHandler å°±ä¼šè¿›è¡Œç»§ç»­è¿›è¡Œæ‹¦æˆªï¼Œç›´åˆ° flush æ¬¡æ•°æ»¡è¶³äº†åæ‰ä¼šè¿›è¡Œæœ€åçš„ flushï¼Œè¯»äº‹ä»¶å·²ç»ç»“æŸçš„è¯ç›´æ¥è°ƒç”¨æœ€åçš„ flush</p>
<p>è¿™å°±è§£ç­”äº†ä¸Šé¢çš„é—®é¢˜ï¼Œå¦‚æœ flush æ¬¡æ•°ä¸å¤Ÿï¼Œä½†æ˜¯è¯»äº‹ä»¶å·²ç»ç»“æŸäº†ï¼Œä¾ç„¶ä¼šè¿›è¡Œ flushã€‚</p>
<p>è¿™æ—¶ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ„Ÿè§‰è¿™ä¸ª FlushConsolidationHandler æ²¡ä»€ä¹ˆç”¨ï¼Œå› ä¸ºä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘åªè¦ä¸è°ƒç”¨ ctx.writeAndFlush() å³å¯ï¼Œåªè°ƒç”¨ ctx.write ()ï¼Œç„¶åå†åç»­ flush æ‰ã€‚</p>
<p>å¯¹çš„ï¼Œè¿™ä¸ªåœ¨ Netty çš„å®˜æ–¹ demo ä¸­å°±æ˜¯è¿™æ ·å®ä¾‹çš„ï¼Œåªåœ¨è¯»äº‹ä»¶ç»“æŸåæ‰è¿›è¡Œ ctx.flush()<br>
/**</p>
<ul>
<li>
<p>Handler implementation for the echo server.<br>
*/<br>
@Sharable<br>
public class EchoServerHandler extends ChannelInboundHandlerAdapter {</p>
<p>@Override<br>
public void channelRead(ChannelHandlerContext ctx, Object msg) {<br>
ctx.write(msg);<br>
}</p>
<p>@Override<br>
public void channelReadComplete(ChannelHandlerContext ctx) {<br>
ctx.flush();<br>
}</p>
<p>@Override<br>
public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {<br>
// Close the connection when an exception is raised.<br>
cause.printStackTrace();<br>
ctx.close();<br>
}<br>
}</p>
</li>
</ul>
<p>é‚£ä¹ˆè¿™ä¸ª FlushConsolidationHandler æ˜¯æ€ä¹ˆä½¿ç”¨çš„å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ª FlushConsolidationHandler ä¸»è¦æ˜¯åœ¨å¼‚æ­¥å†™ï¼ˆåœ¨ handler ä¸Šæ·»åŠ äº†çº¿ç¨‹æ± ï¼‰çš„æ—¶å€™ä½¿ç”¨çš„ï¼Œæ‹¦æˆªå¤šæ¬¡å¼‚æ­¥å†™å³é€šè¿‡å‰é¢ consolidateWhenNoReadInProgress æ¥æ§åˆ¶ï¼Œè€Œä¸”ä¸ºäº†é˜²æ­¢å¼‚æ­¥å†™æœªæ‰§è¡Œå¤Ÿè®¾å®šçš„ explicitFlushAfterFlushes ï¼Œä¼šæ·»åŠ ä¸€ä¸ª future æ¥è¿›è¡Œè°ƒç”¨æœ€åçš„ flush</p>
<p>å› ä¸º Netty çš„çº¿ç¨‹æ¨¡å‹æ˜¯ä¸€ä¸ª pipeline ç»‘å®šä¸€ä¸ªåŒä¸€ä¸ª eventLoopï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¹¶å‘æ‰§è¡Œçš„é—®é¢˜ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤šä¸ªè¯»äº‹ä»¶åœ¨ä¸€ä¸ª pipeline ä¸Šå‘ç”Ÿï¼Œåœ¨åŒä¸€æ¬¡è¯»äº‹ä»¶æœªç»“æŸä¹‹å‰ï¼ˆæœªè°ƒç”¨channelReadComplete ä¹‹å‰ï¼‰ éƒ½ä¼šæ˜¯ readInProgress trueï¼Œä¿è¯ flush çš„æ‰§è¡Œå¯ä»¥åœ¨è¯»äº‹ä»¶å¤„ç†å®Œåè¿›è¡Œï¼Œå¦‚æœè¯»äº‹ä»¶ç»“æŸäº†ï¼Œå°±å¯ä»¥ç›´æ¥ flush å‡ºå»ã€‚</p>
<p>ä½†æ˜¯åœ¨ä¸€ä¸ª pipeline ä¸Šçš„è¯»äº‹ä»¶å®Œæˆäº†ä¸å¸¦è¡¨çœŸæ­£çš„è¯»äº‹ä»¶å®Œæˆäº†ï¼Œå¦‚æœè¯»äº‹ä»¶æ˜¯åœ¨å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ± çš„ä¸šåŠ¡çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè™½ç„¶å½“å‰ pipelin ä¸Šçš„è¯»äº‹ä»¶å·²ç»è¿”å›äº†ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡æœ‰è°ƒç”¨ writeAndFlushã€‚<br>
consolidateWhenNoReadInProgress å‚æ•°çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†åº”å¯¹è¿™ç§é—®é¢˜ã€‚</p>
<p>çœ‹ä¸‹å®ä¾‹çš„å¼‚æ­¥å†™æƒ…å†µï¼š<br>
UnorderedThreadPoolEventExecutor eventExecutors = new UnorderedThreadPoolEventExecutor(10);<br>
try {<br>
serverBootstrap.group(boss, worker)<br>
.handler(new LoggingHandler(LogLevel.INFO))<br>
.childHandler(new ChannelInitializer<NioSocketChannel>() {<br>
protected void initChannel(NioSocketChannel ch) throws Exception {<br>
ChannelPipeline pipeline = ch.pipeline();</p>
<pre><code>                pipeline.addLast(new ServerIdleCheckHandler());
                pipeline.addLast(&quot;frameDecoder&quot;, new FrameDecoder());
                pipeline.addLast(&quot;frameEncoder&quot;, new FrameEncoder());

                pipeline.addLast(&quot;protocolEncoder&quot;, new ProtocolEncoder());
                pipeline.addLast(&quot;protocolDecoder&quot;, new ProtocolDecoder());


                pipeline.addLast(new LoggingHandler(LogLevel.INFO));
                pipeline.addLast(eventExecutors, &quot;serviceHandler&quot;, serviceDispatchHandler);

            }
        });
ChannelFuture sync = serverBootstrap.bind(8098).sync();
</code></pre>
<p>pipeline.addLast(eventExecutors, &quot;serviceHandler&quot;, serviceDispatchHandler); å…³é”®åœ¨è¿™è¡Œä»£ç </p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://jiangjinxinn.github.io//tag/M6RXCDY-O" class="tag">
                    Netty
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jiangjinxinn.github.io//post/2019">
                  <h3 class="post-title">
                    # 2019
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
