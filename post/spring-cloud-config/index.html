<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Spring-Cloud-Config | ç©ºè°ƒæˆ¿</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://jiangjinxinn.github.io//favicon.ico?v=1586357466427">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://jiangjinxinn.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://jiangjinxinn.github.io/">
        <img src="https://jiangjinxinn.github.io//images/avatar.png?v=1586357466427" class="site-logo">
        <h1 class="site-title">ç©ºè°ƒæˆ¿</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      Made with ğŸ¸by jiangjinxinn | <a class="rss" href="https://jiangjinxinn.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Spring-Cloud-Config</h2>
            <div class="post-date">2020-04-07</div>
            
            <div class="post-content">
              <h2 id=""></h2>
<h2 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h2>
<h3 id="æŸ¥çœ‹åº”ç”¨é…ç½®ä¿¡æ¯">æŸ¥çœ‹åº”ç”¨é…ç½®ä¿¡æ¯</h3>
<p>config-serverå¯¹åº”çš„åŸŸå/ip+ä¸‹åˆ—èµ„æºè·¯å¾„</p>
<pre><code>/{application}/{profile}[/{label}]
/{application}-{profile}.yml
/{label}/{application}-{profile}.yml
/{application}-{profile}.properties
/{label}/{application}-{profile}.properties
</code></pre>
<p><strong>è¯´æ˜ï¼š</strong><br>
<code>{profile}</code>Â  çš„é»˜è®¤æ˜¯ <code>default</code>Â <br>
<code>{label}</code>Â é»˜è®¤æ˜¯ <code>master</code>Â ï¼Œ <code>{label}</code>Â å¯ä»¥æ˜¯ <code>git branch name</code>Â ã€<code>**commit id**</code>Â ã€ <code>git tag</code>Â <br>
**æ³¨ï¼š**å¡«å†™äº†ä¸å­˜åœ¨çš„ profileï¼Œhttp è¯·æ±‚æ˜¯å¯ä»¥æˆåŠŸçš„ï¼Œè¿”å›æ—¶æ˜¯ä¸ä¼šæœ‰æç¤ºä¿¡æ¯çš„ï¼ˆè¿”å›çš„æ˜¯ defaultï¼‰</p>
<pre><code>$ curl localhost:7050/ground/dnot-exist-profile
{&quot;name&quot;:&quot;ground&quot;,&quot;profiles&quot;:[&quot;dnot-exist-profile&quot;],&quot;label&quot;:null,&quot;version&quot;:&quot;7860aa370d6496d218a8a382fd1331548f340bfe&quot;,&quot;state&quot;:null,&quot;propertySources&quot;:[{&quot;name&quot;:&quot;overrides&quot;,&quot;source&quot;:{&quot;weier.keji&quot;:&quot;ok&quot;,&quot;spring.cloud.config.allowOverride&quot;:&quot;true&quot;,&quot;override&quot;:&quot;override&quot;,&quot;spring.cloud.config.overrideSystemProperties&quot;:&quot;false&quot;}},{&quot;name&quot;:&quot;https://gitlab.weierai.com/respo/dev/ground.git/application.yml&quot;,&quot;source&quot;:{&quot;spring.data.mongodb.uri&quot;:&quot;mongodb://sprint:mxAVrve5IGLfu5W7@dds-bp15cde8d945b2e41.mongodb.rds.aliyuncs.com:3717,dds-bp15cde8d945b2e42.mongodb.rds.aliyuncs.com:3717/b2_sprint_db?replicaSet=mgset-17069483&quot;,&quot;spring.zipkin.base-url&quot;:&quot;http://172.16.16.65:9411&quot;,&quot;spring.profiles.active&quot;:&quot;default&quot;,&quot;eureka.instance.prefer-ip-address&quot;:true,&quot;eureka.instance.health-check-url-path&quot;:&quot;/actuator/health&quot;,&quot;eureka.instance.instance-id&quot;:&quot;${spring.cloud.client.hostname}:${server.port}:${eureka.instance.metadata-map.routingTag:default}&quot;,&quot;eureka.client.serviceUrl.defaultZone&quot;:&quot;http://172.16.16.65:9997/eureka/&quot;,&quot;feign.compression.request.enabled&quot;:true,&quot;feign.okhttp.enabled&quot;:true,&quot;feign.httpclient.enabled&quot;:false,&quot;feign.hystrix.enabled&quot;:false,&quot;gitlab.gitHost&quot;:&quot;https://gitlab.weierai.com/&quot;,&quot;gitlab.gitApiToken&quot;:&quot;zx-uSqmDNZKsFi2y7hK5&quot;,&quot;server.port&quot;:8080}}]}â
</code></pre>
<h3 id="config-severé…ç½®åˆå¹¶è¦†ç›–ç­–ç•¥">config-severé…ç½®åˆå¹¶è¦†ç›–ç­–ç•¥</h3>
<h4 id="é…ç½®å®Œå…¨è¦†ç›–">é…ç½®å®Œå…¨è¦†ç›–</h4>
<p>å¯ä»¥è¦†ç›–æ‰€æœ‰è¿æ¥åˆ° config-server çš„å®¢æˆ·ç«¯çš„é…ç½®<br>
server æ·»åŠ ä¸‹é¢çš„é…ç½®å</p>
<pre><code class="language-yaml">spring:
  cloud:
    config:
      server:
        overrides:
          foo: bar
          weier:
            keji: ok
</code></pre>
<p>å°±å¯ä»¥æŠŠ client environment ä¸­ foo çš„å€¼è®¾ç½®ä¸º barï¼Œweier.keji è®¾ç½®ä¸º ok<br>
override ä¼˜å…ˆçº§é«˜äºåœ¨ git ä»“åº“ä¸­çš„é…ç½®ã€‚</p>
<p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#property-overrides">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#property-overrides</a></p>
<h4 id="é…ç½®ä¼˜å…ˆçº§">é…ç½®ä¼˜å…ˆçº§</h4>
<p>config çš„æ ¸å¿ƒæ¦‚å¿µä¸ spring çš„ <code>Environment</code> å’Œ <code>PropertySource</code> ä¸€è‡´ï¼Œä» config è·å–åˆ°çš„é…ç½®éƒ½ä¼šè¢«æ•´åˆè¿› Spring çš„ <code>Environment</code> ä¸­ã€‚</p>
<p>é…ç½®æº <code>PropertySource</code>Â çš„ä¼˜å…ˆçº§å¯¹åº”äº <code>Environment</code>Â ä¸­çš„ <code>PropertiesSourceLists</code> ä¸­çš„æ’åˆ—é¡ºåºï¼Œè¶Šå‰é¢çš„ä¼˜å…ˆçº§è¶Šé«˜ã€‚<br>
<img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585741788386-aca070cb-834a-488f-ad8b-50ddd95562d9.png#align=left&amp;display=inline&amp;height=821&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=1642&amp;originWidth=2880&amp;size=1444003&amp;status=done&amp;style=none&amp;width=1440" alt="å›¾ç‰‡.png" loading="lazy"></p>
<p>spring åº”ç”¨ä¸­å¯ä»¥é€šè¿‡æ³¨å…¥æ‹¿åˆ° Environment</p>
<pre><code class="language-java">@Autowired
private Environment environment;
</code></pre>
<p>åœ¨ spring-cloud-config çš„é»˜è®¤é…ç½®ä¸‹<br>
é…ç½®æºä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p>
<ol>
<li>config-overrides</li>
<li>config: application-{profile}.yml</li>
<li>config: application.yml</li>
<li>config: bootstrap.yml</li>
<li>system.properties ï¼ˆ-D vm å‚æ•°ï¼‰</li>
<li>application-{profile}.yml</li>
<li>application.yml</li>
<li>bootstrap.yml</li>
</ol>
<p>-D çš„ vm å‚æ•°é»˜è®¤ä¼šè¢« config è¦†ç›–ï¼Œå¯ä»¥é€šè¿‡åœ¨ git ä»“åº“ä¸­ä¿®æ”¹ç³»ç»Ÿå˜é‡è¦†ç›–ç­–ç•¥æ¥ä¿®æ”¹è¿™ä¸ªè¡Œä¸º</p>
<pre><code class="language-yaml">cloud:
	config:
  	# æ˜¯å¦è¦†ç›–ç³»ç»Ÿå‚æ•°
		override-system-properties: false
</code></pre>
<p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªè¦†ç›–é…ç½®åªæœ‰ä» config æ‹‰å–åˆ°æ‰ä¼šç”Ÿæ•ˆï¼Œåº”ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶é…ç½®äº†è¿™ä¸ªå‚æ•°æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬ä½¿ç”¨äº† git ä½œä¸º config çš„åå¤‡æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œè¿™ä¸ªå‚æ•°åªæœ‰ä¿®æ”¹åœ¨ git ä»“åº“ä¸­æ‰ä¼šç”Ÿæ•ˆ</p>
<h4 id="é…ç½®åˆå¹¶ç­–ç•¥">é…ç½®åˆå¹¶ç­–ç•¥</h4>
<p>ä»ä½¿ç”¨çš„è§’åº¦ä¸Šçœ‹ï¼Œå¤šä¸ªé…ç½®æºçš„é…ç½®åƒæ˜¯åšäº†åˆå¹¶è¦†ç›–çš„ã€‚<br>
å®é™…ä¸Šåœ¨è·å–é…ç½®çš„æ—¶å€™æ˜¯æŒ‰ç…§é…ç½®ä¼˜å…ˆçº§è·å–çš„ï¼Œæ‰€æœ‰é…ç½®æºä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œä¼˜å…ˆçº§é«˜çš„ï¼Œåœ¨è·å–é…ç½®é¡¹çš„æ—¶å€™ä¼˜å…ˆè¿”å›ï¼ŒæŸ¥æ‰¾ä¸åˆ°å°±åˆ°ä¸‹ä¸€ä¸ªé…ç½®æºä¸­è·å–ã€‚<br>
å¯¹åº”äº <code>Environment</code> ä¸­çš„ <code>PropertiesSourceLists</code>Â <br>
ç›¸å…³ä»£ç ï¼š</p>
<p><code>org.springframework.core.env.PropertySourcesPropertyResolver#getProperty(java.lang.String, java.lang.Class&lt;T&gt;, boolean)</code> ï¼Œä» <code>Environmet</code> ä¸­è·å–é…ç½®ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šéå† <code>PropertySourceLists</code>Â æŸ¥æ‰¾åˆ°äº†ç›¸å…³çš„é…ç½®å°±ä¼šç«‹å³è¿”å›ã€‚<br>
<img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585791557211-a1766dd5-1fa1-4672-913d-bd097e0837e1.png#align=left&amp;display=inline&amp;height=443&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=886&amp;originWidth=1678&amp;size=743094&amp;status=done&amp;style=none&amp;width=839" alt="å›¾ç‰‡.png" loading="lazy"></p>
<h3 id="åŠ å¯†é…ç½®æ–‡ä»¶">åŠ å¯†é…ç½®æ–‡ä»¶</h3>
<h4 id="server-åŠ å…¥é…ç½®å¼€å¯-client-è§£å¯†åŠ å¯†æ–‡æœ¬">server åŠ å…¥é…ç½®ï¼Œå¼€å¯ client è§£å¯†åŠ å¯†æ–‡æœ¬</h4>
<pre><code class="language-yaml">spring.cloud.config.server.encrypt.enabled=false
</code></pre>
<h4 id="server-client-åŠ å…¥å¯†é’¥">serverã€client åŠ å…¥å¯†é’¥</h4>
<p>å¯†é’¥å¯ä»¥é€šè¿‡ -D å‚æ•°åŠ å…¥Â <code>encrypt.key=${PASSWORD}</code><br>
é…ç½®åœ¨ bootstrap.yml ä¸­</p>
<pre><code>encrypt.key=some-secret
# encrypt.key=${PASSWORD}
</code></pre>
<h4 id="åŠ å¯†é…ç½®æ–‡ä»¶-2">åŠ å¯†é…ç½®æ–‡ä»¶</h4>
<p>yaml ä¸­<br>
åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åŠ ä¸Š <code>{cipher}</code> å³å¯ï¼Œ<strong>yml ä¸­éœ€è¦åŠ å¼•å·</strong></p>
<pre><code class="language-yaml">spring:
  datasource:
    username: dbuser
    password: '{cipher}FKSAJDFGYOS8F7GLHAKERGFHLSAJ'
</code></pre>
<p>propertiesä¸­<br>
æ³¨æ„ï¼šproperties ä¸­ä¸éœ€è¦åŠ   <code>''</code></p>
<pre><code>spring.datasource.username: dbuser
spring.datasource.password: {cipher}FKSAJDFGYOS8F7GLHAKERGFHLSAJ
</code></pre>
<h4 id="server-åŠ å¯†çš„-endpoint">server åŠ å¯†çš„ endpoint</h4>
<p>/encrypt/statusï¼šåŠ å¯†åŠŸèƒ½çŠ¶æ€<br>
/keyï¼šç§˜é’¥ä¿¡æ¯<br>
/encryptï¼Œpost è¯·æ±‚<br>
/decryptï¼Œpost è¯·æ±‚</p>
<p><strong>è·å–åŠ å¯†æ–‡æœ¬</strong></p>
<pre><code class="language-yaml">$ curl localhost:7050/encrypt -d password
</code></pre>
<p><strong>è·å–è§£å¯†æ–‡æœ¬</strong></p>
<pre><code class="language-yaml">$ curl localhost:7050/decrypt -d fjsakldfjfdkfjlflkjfsdkljflsdjf
</code></pre>
<p>**å°æç¤ºï¼šè¿›è¡Œ curl æµ‹è¯•çš„æ—¶å€™ï¼Œ **<code>**--data-urlencode**</code> ç”¨äºæ­£ç¡® url ç¼–ç </p>
<p>If you testing with curl, then use &gt; <code>--data-urlencode</code> (instead of &gt; <code>-d</code>) or set an explicit &gt; <code>Content-Type: text/plain</code> to make sure curl encodes the data correctly when there are special characters ('+' is particularly tricky).<br>
<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_encryption_and_decryption">ä¹Ÿå¯ä»¥ä½¿ç”¨ spring çš„ cli åŠ è§£å¯†</a></p>
<h4 id="åˆ·æ–°-client-é…ç½®-ç°åº¦å‘å¸ƒ"><a href="https://github.com/spring-cloud/spring-cloud-config#spring-cloud-config-client">åˆ·æ–° client é…ç½®ã€ç°åº¦å‘å¸ƒ</a></h4>
<p>åœ¨ä¸€äº›å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ·æ–° client çš„é…ç½®ï¼Œclient å¼•å…¥ <code>spring-boot-actuator-starter</code>Â  å³å¯<br>
client æ·»åŠ  actuator çš„é…ç½®ï¼Œå°† /refresh ç«¯ç‚¹æš´éœ²å‡ºæ¥</p>
<pre><code class="language-yaml">management:
  endpoints:
    enabled-by-default: true
    web:
      exposure:
      # è¿™é‡ŒæŒ‰éœ€é…ç½®
        include: health,info,refresh
      base-path: /actuator
  endpoint:
    health:
      show-details: always
</code></pre>
<p>åœ¨éœ€è¦åˆ·æ–°é…ç½®çš„ç±»ä¸Šæ·»åŠ  <code>@RefreshScope</code> æ³¨è§£</p>
<pre><code class="language-java">package com.wekj.ground.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;

@RestController
@RefreshScope
public class TestController {
    @Autowired
    private Environment environment;

    @Value(&quot;${foo:bar}&quot;)
    private String foo;

    @GetMapping(&quot;foo&quot;)
    public String getFoo() {
        return foo;
    }
}
</code></pre>
<p>è°ƒç”¨ actuator ç«¯ç‚¹è¿›è¡Œåˆ·æ–°ï¼š</p>
<pre><code>$ curl -X POST http://localhost:7010/actuator/refresh
</code></pre>
<pre><code>{&quot;code&quot;:1,&quot;msg&quot;:&quot;æ“ä½œæˆåŠŸ!&quot;,&quot;data&quot;:[&quot;foo&quot;]}
</code></pre>
<p>è°ƒç”¨ /refresh åˆ·æ–° bean çš„æ—¶å€™ï¼Œä¼šå°†éœ€è¦åˆ·æ–°çš„ bean é”€æ¯æ‰ï¼Œä¸‹æ¬¡ä» bean factory é‡æ–°è·å– bean æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–ä¸€éã€‚<br>
ä¾èµ–äº†å¯åˆ·æ–° bean çš„ bean æ³¨å…¥çš„æ˜¯åˆ·æ–° bean çš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<h3 id="é…ç½®ç¼“å­˜">é…ç½®ç¼“å­˜</h3>
<p><a href="">é»˜è®¤ server ç«¯æ˜¯ä¸ä¼šç¼“å­˜è·å–åˆ°çš„é…ç½®çš„</a>ï¼Œclient ä¹Ÿä¸ä¼šæœ‰ç¼“å­˜</p>
<h4 id="server-ç«¯å¦‚ä½•ç¼“å­˜é…ç½®">server ç«¯å¦‚ä½•ç¼“å­˜é…ç½®</h4>
<p>client åˆ° sever è·å–é…ç½®çš„æ—¶å€™ï¼Œserver ä¼šä» git ä»“åº“è·å–ï¼Œé»˜è®¤æ˜¯æ¯æ¬¡è·å–é…ç½®éƒ½ä» git ä»“åº“è·å–ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®åšåˆ° server ç¼“å­˜é…ç½®åŠŸèƒ½</p>
<pre><code class="language-yaml"># å•ä½ sï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºæ¯æ¬¡è·å–é…ç½®éƒ½ä»è¿œç¨‹ git ä»“åº“è·å–
spring.cloud.config.server.git.refreshRate=0
</code></pre>
<blockquote>
<h5 id="git-refresh-rate"><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_git_refresh_rate">Git Refresh Rate</a></h5>
</blockquote>
<p>You can control how often the config server will fetch updated configuration data from your Git backend by using &gt; <code>spring.cloud.config.server.git.refreshRate</code>. The value of this property is specified in seconds. By default the value is 0, meaning the config server will fetch updated configuration from the Git repo every time it is requested.<br>
server æ˜¯å¦åˆ·æ–°ç¼“å­˜ä»£ç ï¼š<br>
<code>org.springframework.cloud.config.server.environment.JGitEnvironmentRepository#refresh</code><br>
server ç¼“å­˜å­˜æ”¾åœ°æ–¹å¯ä»¥ä¿®æ”¹</p>
<pre><code>spring.cloud.config.server.git.basedir=
</code></pre>
<p>server çš„ç¼“å­˜ä¼šåœ¨ server å…³é—­çš„æ—¶å€™åˆ é™¤æ‰ <code>org.springframework.cloud.config.server.support.AbstractScmAccessor#createBaseDir</code>Â <br>
åœ¨ server å¯åŠ¨åï¼Œgit è¿œç¨‹ä»“åº“è¿æ¥ä¸ä¸Šäº†ï¼Œè¿™æ—¶ä¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚</p>
<h4 id="å®¢æˆ·ç«¯ç¼“å­˜é…ç½®">å®¢æˆ·ç«¯ç¼“å­˜é…ç½®</h4>
<p><strong>å®¢æˆ·ç«¯æ˜¯ä¸ä¼šç¼“å­˜ä» config è·å–åˆ°çš„é…ç½®çš„</strong></p>
<p>ç›¸å…³ä»£ç åœ¨ï¼š<br>
<code>org.springframework.cloud.config.client.ConfigServicePropertySourceLocator#locate</code><br>
<code>org.springframework.cloud.config.client.ConfigServicePropertySourceLocator#getRemoteEnvironment</code><br>
å¯ä»¥åœ¨ <code>getRemoteEnvironment</code> è¿™ä¸ªæ–¹æ³•ä¸­çœ‹åˆ°æ¯æ¬¡è·å–é…ç½®éƒ½æ˜¯å‘èµ· http è¯·æ±‚åˆ° server çš„ï¼Œè·å–ä¸åˆ°é…ç½®çš„è¯ï¼Œå†æ ¹æ®æ˜¯å¦é…ç½®äº†å¿«é€Ÿå¤±è´¥æŠ›å‡ºå¼‚å¸¸ã€‚<br>
<img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585756508026-2b053719-0fdf-4c26-8f1a-8c40ca5dec65.png#align=left&amp;display=inline&amp;height=729&amp;name=image.png&amp;originHeight=729&amp;originWidth=967&amp;size=137709&amp;status=done&amp;style=none&amp;width=967" alt="image.png" loading="lazy"></p>
<figure data-type="image" tabindex="1"><img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585756403102-dfc217f2-184d-4474-ad41-95cfd28bd1d6.png#align=left&amp;display=inline&amp;height=495&amp;name=image.png&amp;originHeight=495&amp;originWidth=1128&amp;size=85782&amp;status=done&amp;style=none&amp;width=1128" alt="image.png" loading="lazy"></figure>
<h3 id="æœ¬åœ°å¼€å‘æ–¹æ¡ˆ">æœ¬åœ°å¼€å‘æ–¹æ¡ˆ</h3>
<h4 id="æœ¬åœ°å¼€å‘æ–¹æ¡ˆ-2">æœ¬åœ°å¼€å‘æ–¹æ¡ˆ</h4>
<p>1ã€éœ€è¦ä¿®æ”¹é…ç½®çš„è¯ï¼Œåœ¨é…ç½®ä»“åº“æ‹‰ feature åŒååˆ†æ”¯<br>
2ã€éªŒè¯æ— è¯¯åæäº¤merger requeståˆå¹¶åˆ°å¯¹åº”ç¯å¢ƒ</p>
<h4 id="å‘å¸ƒæµç¨‹">å‘å¸ƒæµç¨‹</h4>
<p>å»ºè®®ï¼šæœ¬åœ°å¼€å‘å¯ä»¥åªç•™ä¸‹ä¸€ä¸ª bootstrap.ymlï¼Œapplication.yml éƒ½å»æ‰</p>
<h4 id="label-ç‰¹ç‚¹">label ç‰¹ç‚¹</h4>
<p><strong>label åº”è¯¥ç†è§£æˆé…ç½®çš„ç‰ˆæœ¬æ§åˆ¶ï¼ŒæŒ‡å®š label å°±æ˜¯æŒ‡å®šé…ç½®çš„å“ªä¸ªç‰ˆæœ¬</strong></p>
<p>label å¯ä»¥æŒ‡å®šå¤šä¸ª labelï¼Œåœ¨æŒ‡å®šå¤šä¸ª label çš„æ—¶å€™ï¼Œä¼šä¸€ä¸ªä¸ªå°è¯•è·å–ç›¸å¯¹åº” label çš„é…ç½®ï¼Œç›´åˆ°ä¸€ä¸ª label æˆåŠŸä¸ºæ­¢ï¼Œè¿™åœ¨å¼€å‘ feature åˆ†æ”¯æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼šå…ˆæŸ¥è¯¢ myfeature label æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯æ‹‰å–åˆ°é…ç½®å°±ä¼šåœæ­¢ï¼Œdevelop  çš„é…ç½®ä¼šè¢«æŠ›å¼ƒï¼Œå¦‚æœ myfeature ä¸å­˜åœ¨ï¼Œå°±ä¼šè·å– develop label çš„é…ç½®ã€‚</p>
<pre><code>spring.cloud.config.label=myfeature,develop
</code></pre>
<h4 id="å¤šé…ç½®æ–‡ä»¶æ–¹æ¡ˆ">å¤šé…ç½®æ–‡ä»¶æ–¹æ¡ˆ</h4>
<p>éœ€è¦æŒ‡å®šå¤šä¸ª profile çš„è¯è¿™æ ·é…ç½®åˆ° bootstrap.yml ä¸­</p>
<pre><code class="language-yaml">spring: 
  cloud:
    config:
      uri: http://localhost:7050
      label: local
      username: user
      password: password
      allowOverride: true
      overrideNone: true
      overrideSystemProperties: false
      # é…ç½®æ¿€æ´»çš„ profile
      profile: default,local
</code></pre>
<p>åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°† bootstrap.yml profile ä¸­æŒ‡å®šçš„é…ç½®æ‹‰å–ä¸‹æ¥ï¼Œå†ç»“åˆæœ¬åœ°çš„é…ç½®ã€‚<br>
åº”ç”¨å¯åŠ¨çš„é…ç½®æ¥æºäºä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯è·å–åˆ°çš„äº‘ç«¯é…ç½®ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°é…ç½®ï¼Œä¸¤æ¬¡è·å–éƒ½å¯ä»¥æŒ‡å®šéœ€è¦è·å–çš„ profileï¼Œä¸ä¼šè¦†ç›–ã€‚<br>
è¿™é‡Œçš„æ„æ€å°±æ˜¯ï¼Œäº‘ç«¯æ— æ³•è¦†ç›–åº”ç”¨å¯åŠ¨æŒ‡å®šçš„ profileï¼Œåªèƒ½è·å– spring.cloud.config.profile å¯¹åº”çš„é…ç½®ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585814345069-3ac09333-feea-4ebb-8879-02c0bf0c75a8.png#align=left&amp;display=inline&amp;height=435&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=870&amp;originWidth=2880&amp;size=1345204&amp;status=done&amp;style=none&amp;width=1440" alt="å›¾ç‰‡.png" loading="lazy"></figure>
<h3 id="serveré«˜å¯ç”¨-å®‰å…¨æ€§">serveré«˜å¯ç”¨ã€å®‰å…¨æ€§</h3>
<h4 id="client-å¥åº·æ£€æŸ¥">client å¥åº·æ£€æŸ¥</h4>
<p>æ£€æµ‹æ˜¯å¦èƒ½è¿æ¥ sever æˆåŠŸï¼Œå¯ä»¥ä¸æ‰“å¼€ï¼Œå› ä¸ºåŠ¨æ€åˆ·æ–°éœ€æ±‚çš„å¾ˆå°‘ã€‚åº”ç”¨å¯åŠ¨æˆåŠŸåï¼Œserver down æ‰ä¹Ÿä¸å½±å“åº”ç”¨ã€‚</p>
<pre><code>health.config.enabled=false
# å¥åº·æ£€æŸ¥å‘¨æœŸé»˜è®¤ 5 åˆ†é’Ÿï¼Œå•ä½ ms
health.config.time-to-live=milliseconds
</code></pre>
<h4 id="client-å¯åŠ¨å¿«é€Ÿå¤±è´¥">client å¯åŠ¨å¿«é€Ÿå¤±è´¥</h4>
<p><strong>å¼ºçƒˆå»ºè®®æ‰“å¼€ï¼š</strong></p>
<pre><code>spring.cloud.config.fail-fast=true
</code></pre>
<p>æ‰“å¼€åå®¢æˆ·ç«¯å¿«é€Ÿå¤±è´¥åï¼Œåº”ç”¨å¯åŠ¨æ—¶ï¼Œå¦‚æœè¿æ¥ä¸ä¸Š server å°±ä¼šåœæ­¢å¯åŠ¨ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰æ‰“å¼€çš„ï¼Œè¿æ¥å¤±è´¥åªä¼šæ‰“å° warn æ—¥å¿—ã€‚<br>
å¹¶ä¸”åœ¨åº”ç”¨å¯åŠ¨æˆåŠŸåï¼Œå¦‚æœ server æŒ‚äº†ï¼Œåº”ç”¨æ˜¯ä¸ä¼šå—åˆ°å½±å“çš„ã€‚åœ¨åˆ·æ–°é…ç½®çš„æ—¶å€™ä¼šæç¤º server down äº†ã€‚</p>
<h4 id="client-å¯†ç è¿æ¥-server">client å¯†ç è¿æ¥ server</h4>
<p>server å¼•å…¥ <code>spring-security</code> çš„ starter</p>
<pre><code># ä¸é…ç½®çš„è¯é»˜è®¤æ˜¯ user
spring.security.user.name
# ä¸é…ç½®çš„è¯ä¼šéšæœºç”Ÿæˆä¸€ä¸ªå¯†ç 
spring.security.user.password
</code></pre>
<pre><code>$ curl user:password@localhost:7050/ground/default/master
</code></pre>
<p>config-client æŠŠå¯†ç é…ç½®åˆ° spring.cloud.config ä¸‹é¢</p>
<pre><code class="language-yaml">spring:
  application:
    name: ground
  cloud:
    config:
      uri: http://localhost:7050
      label: local
      fail-fast: true
      username: user
      password: password
</code></pre>
<ol>
<li>å¦‚æœè¿æ¥ server çš„å¯†ç é”™è¯¯ï¼Œå¯åŠ¨æŠ¥é”™ä¸ä¼šæç¤ºå¯†ç é”™è¯¯ï¼Œè€Œæ˜¯ä¸‹é¢çš„è¿™ä¸ªé”™è¯¯ï¼ˆæ‰“å¼€å¿«é€Ÿå¤±è´¥å¾ˆæœ‰å¿…è¦ï¼‰</li>
</ol>
<pre><code>java.lang.IllegalStateException: Could not locate PropertySource and the fail fast property is set, failing
	at org.springframework.cloud.config.client.ConfigServicePropertySourceLocator.locate(ConfigServicePropertySourceLocator.java:148) ~[spring-cloud-config-client-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.bootstrap.config.PropertySourceLocator.locateCollection(PropertySourceLocator.java:52) ~[spring-cloud-context-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.config.client.ConfigServicePropertySourceLocator.locateCollection(ConfigServicePropertySourceLocator.java:163) ~[spring-cloud-config-client-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration.initialize(PropertySourceBootstrapConfiguration.java:97) ~[spring-cloud-context-2.2.2.RELEASE.jar:2.2.2.RELEASE]
</code></pre>
<h4 id="server-å¯åŠ¨é…ç½®æ¥è‡ª-config">server å¯åŠ¨é…ç½®æ¥è‡ª config</h4>
<p>å¦‚æœé€‰æ‹©å†…åµŒåœ¨ springboot åº”ç”¨ä¸­å¯åŠ¨ serverï¼Œå¯ä»¥ä½¿ server çš„é…ç½®ä¹Ÿä» git æ‹‰å–<br>
<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_embedding_the_config_server">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_embedding_the_config_server</a></p>

            </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jiangjinxinn.github.io/post/netty-zeng-qiang-xie/">
                  <h3 class="post-title">
                    Netty å¢å¼ºå†™ FlushConsolidationHandler
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
