<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Netty å¯¹ Reactor æ¨¡å¼å¸¸è§çš„ç–‘é—® | ç©ºè°ƒæˆ¿</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://jiangjinxinn.github.io//favicon.ico?v=1588536190875">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://jiangjinxinn.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://jiangjinxinn.github.io/">
        <img src="https://jiangjinxinn.github.io//images/avatar.png?v=1588536190875" class="site-logo">
        <h1 class="site-title">ç©ºè°ƒæˆ¿</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      Made with ğŸ¸by jiangjinxinn | <a class="rss" href="https://jiangjinxinn.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Netty å¯¹ Reactor æ¨¡å¼å¸¸è§çš„ç–‘é—®</h2>
            <div class="post-date">2019-12-15</div>
            
            <div class="post-content">
              <h2 id="netty-å¦‚ä½•æ”¯æŒä¸»ä»-reactor-æ¨¡å¼">Netty å¦‚ä½•æ”¯æŒä¸»ä» Reactor æ¨¡å¼</h2>
<p>ç®€å•æ¥è¯´å°±æ˜¯å°† ä¸¤ç§ channel æ³¨å†Œåˆ°ä¸¤ç§ EventLoopGroupä¸Šã€‚<br>
ä¸»è¦çš„é€»è¾‘åœ¨ å¼•å¯¼ç±» <code>ServerBootstrap</code> çš„ group() ä¸­é…ç½®äº† BossGroup å’Œ WorkGroupï¼Œä¼šåœ¨åé¢ register() å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚</p>
<p>ServerBootstrap.group() æ–¹æ³•:</p>
<pre><code class="language-java">/**
 * Specify the {@link EventLoopGroup} which is used for the parent (acceptor) and the child (client).
 */
@Override
public ServerBootstrap group(EventLoopGroup group) {
    // â‘  éä¸»ä»çš„ Reactor æ¨¡å¼ï¼Œä¸€ä¸ª group å¹²ä¸¤ä¸ªæ´»
    return group(group, group);
}

/**
 * Set the {@link EventLoopGroup} for the parent (acceptor) and the child (client). These
 * {@link EventLoopGroup}'s are used to handle all the events and IO for {@link ServerChannel} and
 * {@link Channel}'s.
 */
// ä¸»ä»æ¨¡å¼çš„ group é…ç½®
public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup) {
    // â‘¡ è®¾ç½® parentGroup å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ boss group 
    super.group(parentGroup);
    if (childGroup == null) {
        throw new NullPointerException(&quot;childGroup&quot;);
    }
    if (this.childGroup != null) {
        throw new IllegalStateException(&quot;childGroup set already&quot;);
    }
    // â‘¢ è®¾ç½® childGroup å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ worker group
    this.childGroup = childGroup;
    return this;
}
</code></pre>
<p>å…ˆçœ‹ä¸‹æ­¥éª¤ â‘¡ è®¾ç½®äº† parentGroup åçš„åŠ¨ä½œã€‚<br>
åœ¨ <code>AbstractBootstrap#initAndRegister</code> åˆå§‹åŒ–ä¸­ä¼šå°†åé¢çš„ <code>ServerSocketChannel</code> æ³¨å†Œåˆ° parent gorup ä¸Šã€‚</p>
<pre><code class="language-java">final ChannelFuture initAndRegister() {
    Channel channel = null;
    try {
        channel = channelFactory.newChannel();
        // âœ…child groupåœ¨è¿™é‡Œåˆå§‹åŒ–
        init(channel);
    } catch (Throwable t) {
        if (channel != null) {
            // channel can be null if newChannel crashed (eg SocketException(&quot;too many open files&quot;))
            channel.unsafe().closeForcibly();
        }
        // as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
        return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);
    }
    // âœ… ServerSocketChannel åœ¨è¿™é‡Œæ³¨å†Œåˆ° parent group ä¸Š
    ChannelFuture regFuture = config().group().register(channel);
    if (regFuture.cause() != null) {
        if (channel.isRegistered()) {
            channel.close();
        } else {
            channel.unsafe().closeForcibly();
        }
    }
    return regFuture;
}
</code></pre>
<p>æ¥ç€æ¥çœ‹ä¸‹æ­¥éª¤ â‘¢ ä¸­è®¾ç½® childGroup åçš„æ“ä½œï¼Œå¦‚ä¸Šé¢è´´çš„ä»£ç å¯ä»¥çœ‹åˆ°åœ¨<code>AbstractBootstrap#initAndRegister</code> åŒæ—¶ä¹Ÿåˆå§‹åŒ–äº† childGroup çš„æ“ä½œ</p>
<pre><code class="language-java">void init(Channel channel) throws Exception {
    final Map&lt;ChannelOption&lt;?&gt;, Object&gt; options = options0();
    synchronized (options) {
        setChannelOptions(channel, options, logger);
    }

    final Map&lt;AttributeKey&lt;?&gt;, Object&gt; attrs = attrs0();
    synchronized (attrs) {
        for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: attrs.entrySet()) {
            @SuppressWarnings(&quot;unchecked&quot;)
            AttributeKey&lt;Object&gt; key = (AttributeKey&lt;Object&gt;) e.getKey();
            channel.attr(key).set(e.getValue());
        }
    }

    ChannelPipeline p = channel.pipeline();
    // â‘  childGroup æ¢äº†ä¸€ä¸ªåå­—
    final EventLoopGroup currentChildGroup = childGroup;
    final ChannelHandler currentChildHandler = childHandler;
    final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;
    final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;
    synchronized (childOptions) {
        currentChildOptions = childOptions.entrySet().toArray(newOptionArray(childOptions.size()));
    }
    synchronized (childAttrs) {
        currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(childAttrs.size()));
    }

    p.addLast(new ChannelInitializer&lt;Channel&gt;() {
        @Override
        public void initChannel(final Channel ch) throws Exception {
            final ChannelPipeline pipeline = ch.pipeline();
            ChannelHandler handler = config.handler();
            if (handler != null) {
                pipeline.addLast(handler);
            }

            ch.eventLoop().execute(new Runnable() {
                @Override
                public void run() {
                    // â‘¡ ä¼ é€’ç»™ ServerBootstrapAcceptor
                    pipeline.addLast(new ServerBootstrapAcceptor(
                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));
                }
            });
        }
    });
</code></pre>
<p>åœ¨ â‘¡ ä¸­å°† childGroup ä¼ é€’ç»™äº† <code>ServerBootstrapAcceptor</code>ï¼Œ ä»–å…¶å®æ˜¯ä¸ª <code>ChannelInboundHandlerAdapter</code>ï¼Œåœ¨ä»–çš„é‡å†™æ–¹æ³•<code>ServerBootstrap.ServerBootstrapAcceptor#channelRead</code>ä¸­å°†åç»­æ”¶åˆ°çš„ <code>SocketChannel</code> æ³¨å†Œåˆ° childGroup ä¸Š</p>
<pre><code class="language-java">@Override
@SuppressWarnings(&quot;unchecked&quot;)
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    // â‘  è¿™ä¸ª msg å°±æ˜¯ SocketChannel
    final Channel child = (Channel) msg;

    child.pipeline().addLast(childHandler);

    setChannelOptions(child, childOptions, logger);

    for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) {
        child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());
    }

    try {
        // â‘¡ æ³¨å†Œåˆ° childGroup ä¸Š
        childGroup.register(child).addListener(new ChannelFutureListener() {
            @Override
            public void operationComplete(ChannelFuture future) throws Exception {
                if (!future.isSuccess()) {
                    forceClose(child, future.cause());
                }
            }
        });
    } catch (Throwable t) {
        forceClose(child, t);
    }
}
</code></pre>
<h2 id="ä¸ºä»€ä¹ˆè¯´-netty-çš„-main-reactor-å¤§å¤šå¹¶ä¸èƒ½ç”¨åˆ°ä¸€ä¸ªçº¿ç¨‹ç»„åªèƒ½çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª">ä¸ºä»€ä¹ˆè¯´ Netty çš„ main reactor å¤§å¤šå¹¶ä¸èƒ½ç”¨åˆ°ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œåªèƒ½çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª</h2>
<p>å› ä¸ºå¤§å¤šåªç»‘å®šä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å°±åªç”¨åˆ°çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª<br>
<code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p>
<h2 id="netty-ç»™-channel-åˆ†é…-nio-event-loop-çš„è§„åˆ™æ˜¯ä»€ä¹ˆ">Netty ç»™ Channel åˆ†é… NIO event loop çš„è§„åˆ™æ˜¯ä»€ä¹ˆ</h2>
<p>å¯¹äº NIO çš„ EventLoopGroup çš„å®ç°æ˜¯<code>MultithreadEventLoopGroup#register(io.netty.channel.Channel)</code></p>
<pre><code class="language-java">    @Override
    public ChannelFuture register(Channel channel) {
        // è¿™é‡Œçš„ next() æ˜¯ä¸ªé€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ä¸ª EventExecutor
        return next().register(channel);
    }
</code></pre>
<p>æœ€åæ˜¯åœ¨ <code>EventExecutorChooserFactory</code> çš„ç­–ç•¥æ¨¡å¼ä¸­é€‰æ‹©ä¸€ä¸ª <code>EventExecutor</code>ï¼Œ</p>
<pre><code class="language-java">/**
 * Factory that creates new {@link EventExecutorChooser}s.
 */
@UnstableApi
public interface EventExecutorChooserFactory {

    /**
     * Returns a new {@link EventExecutorChooser}.
     */
    EventExecutorChooser newChooser(EventExecutor[] executors);

    /**
     * Chooses the next {@link EventExecutor} to use.
     */
    @UnstableApi
    interface EventExecutorChooser {

        /**
         * Returns the new {@link EventExecutor} to use.
         */
        EventExecutor next();
    }
}
</code></pre>
<p>æœ‰ä¸¤ä¸ªå®ç°ç±»ä¸€ä¸ªæ˜¯<code>GenericEventExecutorChooser</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>PowerOfTwoEventExecutorChooser</code>ï¼ŒåŒºåˆ«åœ¨äºé€‰æ‹©ä¸€ä¸‹ä¸ª<code>EventExecutor</code>æ—¶å€™ï¼Œå¦‚æœæ˜¯2çš„å¹‚æ¬¡ï¼Œå¯ä»¥ç›´æ¥æŒ‰ä¸ºä¸ <code>&amp;</code> æ“ä½œï¼Œé«˜æ•ˆä¸€ç‚¹ã€‚</p>
<h2 id="netty-å¦‚ä½•å®ç°å¤šè·¯å¤ç”¨å™¨è·¨å¹³å°çš„">Netty å¦‚ä½•å®ç°å¤šè·¯å¤ç”¨å™¨è·¨å¹³å°çš„</h2>
<p>Netty çš„ NIO Selector å°è£…åœ¨ <code>NioEventLoopGroup</code> ä¸­</p>
<pre><code class="language-java">public NioEventLoopGroup(int nThreads, Executor executor) {
    this(nThreads, executor, SelectorProvider.provider());
}
</code></pre>
<p>é€šè¿‡ <code>SelectorProvider.provider()</code> è·å–ç›¸åº”çš„Selectorã€‚</p>
<pre><code class="language-java">public static SelectorProvider provider() {
    synchronized (lock) {
        if (provider != null)
            return provider;
        return AccessController.doPrivileged(
            new PrivilegedAction&lt;SelectorProvider&gt;() {
                public SelectorProvider run() {
                        // â‘  ä»ç³»ç»Ÿå‚æ•°ä»è·å– nio selector çš„ spi å®ç°
                        if (loadProviderFromProperty())
                            return provider;
                        // â‘¡ é€šè¿‡ java spi åŠ è½½
                        if (loadProviderAsService())
                            return provider;
                        // â‘¢ jdk å®ç°
                        provider = sun.nio.ch.DefaultSelectorProvider.create();
                        return provider;
                    }
                });
    }
}   
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œnio çš„ selector è·å–æœ‰ä¸‰ç§é€”å¾„ï¼Œä¸€èˆ¬æœ€åå°±æ˜¯ sun çš„ jdk ä¸­çš„å®ç°ã€‚åœ¨ mac ä¸­æ˜¯ <code>KQueueSelectorProvider</code>ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://jiangjinxinn.github.io/tag/M6RXCDY-O/" class="tag">
                    Netty
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://jiangjinxinn.github.io/post/sublime-sui-shou-ji/">
                  <h3 class="post-title">
                    Sublime éšæ‰‹è®°
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
