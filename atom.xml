<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://jiangjinxinn.github.io/</id>
    <title>ç©ºè°ƒæˆ¿</title>
    <updated>2020-05-03T20:03:17.205Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://jiangjinxinn.github.io/"/>
    <link rel="self" href="https://jiangjinxinn.github.io/atom.xml"/>
    <logo>https://jiangjinxinn.github.io/images/avatar.png</logo>
    <icon>https://jiangjinxinn.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, ç©ºè°ƒæˆ¿</rights>
    <entry>
        <title type="html"><![CDATA[LoadBalance è‡ªåŠ¨è£…é…]]></title>
        <id>https://jiangjinxinn.github.io/post/loadbalance-zi-dong-zhuang-pei/</id>
        <link href="https://jiangjinxinn.github.io/post/loadbalance-zi-dong-zhuang-pei/">
        </link>
        <updated>2020-05-03T19:36:38.000Z</updated>
        <content type="html"><![CDATA[<p>spring cloud è¿™å—æœ‰ç‚¹å‰å®³ï¼Œç‰ˆæœ¬å‡çº§ååŒ…åå„ç§æ”¹ã€‚ã€‚feignã€openfeignã€netflixfeign å‚»å‚»åˆ†ä¸æ¸…æ¥š</p>
<p>å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡è°ƒç”¨å°±æœ‰ä¸‰ç§ï¼š</p>
<ol>
<li>discovery client</li>
<li>ribbon loadbalanced resttemplate</li>
<li>feignclient</li>
</ol>
<p>è™½ç„¶è¿™äº›ä¹‹é—´éƒ½æ˜¯æœ‰è”ç³»çš„ï¼Œä½†æè¿™ä¹ˆå¤šæ¦‚å¿µçƒ¦ä¸çƒ¦å•Šã€‚ã€‚æˆ‘åˆæ¥ä¹åˆ°ä½¿ç”¨ spring cloud æœ‰ç‚¹æ‡µ</p>
<p>åŸæ¥ä¸€ç›´æ˜¯ç”¨ç¬¬ä¸‰ç§ feign clientï¼Œä»Šå¤©ç”±äºæƒ³è¦å®ç°ä¸ª feign çš„ç¼“å­˜å®ç°ï¼Œä»”ç»†çœ‹äº†ä¸‹ä»£ç </p>
<p>çœ‹åˆ°ç¬¬äºŒç§ ribbon çš„æ—¶å€™ï¼Œçœ‹æ™•äº†ï¼Œè®°å½•ä¸‹æ”¶è·</p>
<ol>
<li>@Qualifier çš„ä½¿ç”¨</li>
</ol>
<p>æ³¨è§£ <code>@Qualifier</code> æ ‡æ³¨äº† <code>@Inherited</code>  å…ƒæ³¨è§£ï¼Œå¹¶ä¸”åœ¨å…¶ä»–è‡ªå®šä¹‰æ³¨è§£ä¸Šæ·»åŠ  <code>@Qualifier</code> æ³¨è§£çš„æ—¶å€™å¯ä»¥åšä¸º <code>qualifier</code> ä½¿ç”¨</p>
<blockquote>
<p>This annotation may be used on a field or parameter as a qualifier for<br>
candidate beans when autowiring. It may also be used to annotate other<br>
custom annotations that can then in turn be used as qualifiers.</p>
</blockquote>
<p><code>@LoadBalanced</code> æ³¨è§£å°±è¢«æ·»åŠ äº† <code>@Qualifier</code> æ³¨è§£æ‰€ä»¥åœ¨ <code>LoadBalancerAutoConfiguration</code> ä¸­å¯ä»¥å®ç°åªæ³¨å…¥è¢« <code>@LoadBalanced</code> æ ‡è®°äº†çš„ <code>Resttemplatet</code>ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://jiangjinxinn.github.io//post-images/1588535143322.png" alt="" loading="lazy"></figure>
<ol start="2">
<li>è‡ªåŠ¨è£…é…åœ¨å®ç°ä¾èµ–ä¸­æ‰“å¼€</li>
</ol>
<p>pring-cloud-commons åŒ…ä¸‹çš„ <code>org.springframework.cloud.client.loadbalancer.LoadBalancerAutoConfiguration</code><br>
å¹¶ä¸ä¼šè‡ªåŠ¨è£…é…ï¼Œåªæœ‰æ·»åŠ äº† <code>spring-cloud-starter-loadbalancer</code> æ‰ä¼šè‡ªåŠ¨è£…é…ã€‚</p>
<pre><code class="language-xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
      &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
      &lt;scope&gt;compile&lt;/scope&gt;
    &lt;/dependency&gt;
</code></pre>
<p>æŒ‰ç…§ spring cloud å®˜æ–¹çš„è¯´æ³•ï¼Œspring cloud common æ˜¯æŠ½è±¡å®ç°ï¼Œåœ¨ spring cloud çš„ä¸åŒå®ç°ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥åƒä¸Šè¿°çš„ loadbalancer åœ¨æ²¡æœ‰å¼• loadbalancer çš„ä¾èµ–çš„æ—¶å€™æ˜¯ä¸ä¼šè‡ªåŠ¨è£…é…çš„</p>
<blockquote>
<p>Spring Cloud Commons delivers features as two libraries: Spring Cloud Context and Spring Cloud Commons. Spring Cloud Context provides utilities and special services for the ApplicationContext of a Spring Cloud application (bootstrap context, encryption, refresh scope and environment endpoints). Spring Cloud Commons is a set of abstractions and common classes used in different Spring Cloud implementations (eg. Spring Cloud Netflix vs. Spring Cloud Consul).</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spring-Cloud-Config]]></title>
        <id>https://jiangjinxinn.github.io/post/spring-cloud-config/</id>
        <link href="https://jiangjinxinn.github.io/post/spring-cloud-config/">
        </link>
        <updated>2020-04-07T01:31:48.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h2>
<h3 id="æŸ¥çœ‹åº”ç”¨é…ç½®ä¿¡æ¯">æŸ¥çœ‹åº”ç”¨é…ç½®ä¿¡æ¯</h3>
<p>config-serverå¯¹åº”çš„åŸŸå/ip+ä¸‹åˆ—èµ„æºè·¯å¾„</p>
<pre><code>/{application}/{profile}[/{label}]
/{application}-{profile}.yml
/{label}/{application}-{profile}.yml
/{application}-{profile}.properties
/{label}/{application}-{profile}.properties
</code></pre>
<p>**<br>
<strong>è¯´æ˜ï¼š</strong><br>
<code>{profile}</code>Â  çš„é»˜è®¤æ˜¯ <code>default</code>Â <br>
<code>{label}</code>Â é»˜è®¤æ˜¯ <code>master</code>Â ï¼Œ <code>{label}</code>Â å¯ä»¥æ˜¯ <code>git branch name</code>Â ã€<code>**commit id**</code>Â ã€ <code>git tag</code>Â <br>
**æ³¨ï¼š**å¡«å†™äº†ä¸å­˜åœ¨çš„ profileï¼Œhttp è¯·æ±‚æ˜¯å¯ä»¥æˆåŠŸçš„ï¼Œè¿”å›æ—¶æ˜¯ä¸ä¼šæœ‰æç¤ºä¿¡æ¯çš„ï¼ˆè¿”å›çš„æ˜¯ defaultï¼‰</p>
<h3 id="config-severé…ç½®åˆå¹¶è¦†ç›–ç­–ç•¥">config-severé…ç½®åˆå¹¶è¦†ç›–ç­–ç•¥</h3>
<h4 id="é…ç½®å®Œå…¨è¦†ç›–">é…ç½®å®Œå…¨è¦†ç›–</h4>
<p>å¯ä»¥è¦†ç›–æ‰€æœ‰è¿æ¥åˆ° config-server çš„å®¢æˆ·ç«¯çš„é…ç½®<br>
server æ·»åŠ ä¸‹é¢çš„é…ç½®å</p>
<pre><code class="language-yaml">spring:
  cloud:
    config:
      server:
        overrides:
          foo: bar
</code></pre>
<p>å°±å¯ä»¥æŠŠ client environment ä¸­ foo çš„å€¼è®¾ç½®ä¸º bar</p>
<p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#property-overrides">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#property-overrides</a></p>
<h4 id="é…ç½®ä¼˜å…ˆçº§">é…ç½®ä¼˜å…ˆçº§</h4>
<p>config çš„æ ¸å¿ƒæ¦‚å¿µä¸ spring çš„ <code>Environment</code> å’Œ <code>PropertySource</code> ä¸€è‡´ï¼Œä» config è·å–åˆ°çš„é…ç½®éƒ½ä¼šè¢«æ•´åˆè¿› Spring çš„ <code>Environment</code> ä¸­ã€‚</p>
<p>é…ç½®æº <code>PropertySource</code>Â çš„ä¼˜å…ˆçº§å¯¹åº”äº <code>Environment</code>Â ä¸­çš„ <code>PropertiesSourceLists</code> ä¸­çš„æ’åˆ—é¡ºåºï¼Œè¶Šå‰é¢çš„ä¼˜å…ˆçº§è¶Šé«˜ã€‚<br>
<img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1586225126977-f58a878f-1097-4a6b-bbff-5ae8734fa08e.png#align=left&amp;display=inline&amp;height=821&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=1642&amp;originWidth=2880&amp;size=1735784&amp;status=done&amp;style=none&amp;width=1440" alt="å›¾ç‰‡.png" loading="lazy"></p>
<p>spring åº”ç”¨ä¸­å¯ä»¥é€šè¿‡æ³¨å…¥æ‹¿åˆ° Environment</p>
<pre><code class="language-java">@Autowired
private Environment environment;
</code></pre>
<p>æ‰“å¼€äº† actuator çš„ env ç«¯ç‚¹åç›´æ¥åˆ° env ç«¯ç‚¹ä¸ŠæŸ¥çœ‹</p>
<p>åœ¨ spring-cloud-config çš„é»˜è®¤é…ç½®ä¸‹<br>
é…ç½®æºä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>config-overrides</p>
</li>
<li>
<p>config: application-{profile}.yml</p>
</li>
<li>
<p>config: application.yml</p>
</li>
<li>
<p>config: bootstrap.yml</p>
</li>
<li>
<p>system.properties ï¼ˆ-D vm å‚æ•°ï¼‰</p>
</li>
<li>
<p>java --sprinng.config.location å¤–éƒ¨æ–‡ä»¶</p>
</li>
<li>
<p>application-{profile}.yml</p>
</li>
<li>
<p>application.yml</p>
</li>
<li>
<p>bootstrap.yml</p>
</li>
</ol>
<p>-D çš„ vm å‚æ•°é»˜è®¤ä¼šè¢« config è¦†ç›–ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ç³»ç»Ÿå˜é‡è¦†ç›–ç­–ç•¥æ¥ä¿®æ”¹è¿™ä¸ªè¡Œä¸º</p>
<pre><code class="language-yaml">cloud:
	config:
  	# æ˜¯å¦è¦†ç›–ç³»ç»Ÿå‚æ•°
		override-system-properties: false
</code></pre>
<p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªè¦†ç›–é…ç½®åªæœ‰ä» config æ‹‰å–åˆ°æ‰ä¼šç”Ÿæ•ˆï¼Œæœ¬åœ°é…ç½®æ–‡ä»¶é…ç½®äº†è¿™ä¸ªå‚æ•°æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚åœ¨ä½¿ç”¨äº† git ä½œä¸º config çš„åå¤‡æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œè¿™ä¸ªå‚æ•°åªæœ‰ä¿®æ”¹åœ¨ git ä»“åº“ä¸­æ‰ä¼šç”Ÿæ•ˆ</p>
<p>java -jar å¤–éƒ¨æ–‡ä»¶æŒ‡å®šå¯åŠ¨ï¼Œè¦æ³¨æ„åŒºåˆ†<br>
--spring.config.location<br>
--spring.config.additional-location</p>
<pre><code>java -jar demo-0.0.1-SNAPSHOT.jar --spring.config.location=classpath:/,file:///Users/x1nn/Desktop/application.yml
</code></pre>
<p>java -jar demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev</p>
<h4 id="é…ç½®åˆå¹¶ç­–ç•¥">é…ç½®åˆå¹¶ç­–ç•¥</h4>
<p>ä»ä½¿ç”¨çš„è§’åº¦ä¸Šçœ‹ï¼Œå¤šä¸ªé…ç½®æºçš„é…ç½®åƒæ˜¯åšäº†åˆå¹¶è¦†ç›–çš„ï¼Œäº‘ç«¯è¦†ç›–äº†æœ¬åœ°é…ç½®ã€‚<br>
å®é™…ä¸Šåœ¨è·å–é…ç½®çš„æ—¶å€™æ˜¯æŒ‰ç…§é…ç½®ä¼˜å…ˆçº§è·å–çš„ï¼Œæ‰€æœ‰é…ç½®æºä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œä¼˜å…ˆçº§é«˜çš„ï¼Œåœ¨è·å–é…ç½®é¡¹çš„æ—¶å€™ä¼˜å…ˆè¿”å›ï¼ŒæŸ¥æ‰¾ä¸åˆ°å°±åˆ°ä¸‹ä¸€ä¸ªé…ç½®æºä¸­è·å–ã€‚<br>
å¯¹åº”äº <code>Environment</code> ä¸­çš„ <code>PropertiesSourceLists</code>Â <br>
ç›¸å…³ä»£ç ï¼š</p>
<p><code>org.springframework.core.env.PropertySourcesPropertyResolver#getProperty(java.lang.String, java.lang.Class&lt;T&gt;, boolean)</code> ï¼Œä» <code>Environmet</code> ä¸­è·å–é…ç½®ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šéå† <code>PropertySourceLists</code>Â æŸ¥æ‰¾åˆ°äº†ç›¸å…³çš„é…ç½®å°±ä¼šç«‹å³è¿”å›ã€‚<br>
<img src="https://cdn.nlark.com/yuque/0/2020/png/132176/1585791557211-a1766dd5-1fa1-4672-913d-bd097e0837e1.png#align=left&amp;display=inline&amp;height=443&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=886&amp;originWidth=1678&amp;size=743094&amp;status=done&amp;style=none&amp;width=839" alt="å›¾ç‰‡.png" loading="lazy"></p>
<h3 id="åŠ å¯†é…ç½®æ–‡ä»¶">åŠ å¯†é…ç½®æ–‡ä»¶</h3>
<h4 id="server-åŠ å…¥é…ç½®å¼€å¯-client-è§£å¯†åŠ å¯†æ–‡æœ¬">server åŠ å…¥é…ç½®ï¼Œå¼€å¯ client è§£å¯†åŠ å¯†æ–‡æœ¬</h4>
<p>é…ç½®åœ¨ bootstrap.yml ä¸­æ‰ä¼šç”Ÿæ•ˆï¼</p>
<pre><code class="language-yaml">spring.cloud.config.server.encrypt.enabled=false
</code></pre>
<h4 id="server-client-åŠ å…¥å¯†é’¥">serverã€client åŠ å…¥å¯†é’¥</h4>
<p>å¯†é’¥å¯ä»¥é€šè¿‡ -D å‚æ•°åŠ å…¥Â <code>encrypt.key=${PASSWORD}</code><br>
é…ç½®åœ¨ bootstrap.yml ä¸­</p>
<pre><code>encrypt.key=some-secret
# encrypt.key=${PASSWORD}
</code></pre>
<h4 id="åŠ å¯†é…ç½®æ–‡ä»¶-2">åŠ å¯†é…ç½®æ–‡ä»¶</h4>
<p>yaml ä¸­<br>
åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åŠ ä¸Š <code>{cipher}</code> å³å¯ï¼Œ<strong>yml ä¸­éœ€è¦åŠ å¼•å·</strong></p>
<pre><code class="language-yaml">spring:
  datasource:
    username: dbuser
    password: '{cipher}FKSAJDFGYOS8F7GLHAKERGFHLSAJ'
</code></pre>
<p>propertiesä¸­<br>
æ³¨æ„ï¼šproperties ä¸­ä¸éœ€è¦åŠ   <code>''</code></p>
<pre><code>spring.datasource.username: dbuser
spring.datasource.password: {cipher}FKSAJDFGYOS8F7GLHAKERGFHLSAJ
</code></pre>
<h4 id="server-åŠ å¯†çš„-endpoint">server åŠ å¯†çš„ endpoint</h4>
<p>/encrypt/statusï¼šåŠ å¯†åŠŸèƒ½çŠ¶æ€<br>
/keyï¼šç§˜é’¥ä¿¡æ¯<br>
/encryptï¼Œpost è¯·æ±‚</p>
<p>/decryptï¼Œpost è¯·æ±‚</p>
<p><strong>è·å–åŠ å¯†æ–‡æœ¬</strong></p>
<pre><code class="language-yaml">$ curl localhost:7050/encrypt -d password
</code></pre>
<p><strong>è·å–è§£å¯†æ–‡æœ¬</strong></p>
<pre><code class="language-yaml">$ curl localhost:7050/decrypt -d fjsakldfjfdkfjlflkjfsdkljflsdjf
</code></pre>
<p>**<br>
**å°æç¤ºï¼šè¿›è¡Œ curl æµ‹è¯•çš„æ—¶å€™ï¼Œ **<code>**--data-urlencode**</code> ç”¨äºæ­£ç¡® url ç¼–ç </p>
<p>If you testing with curl, then use &gt; <code>--data-urlencode</code> (instead of &gt; <code>-d</code>) or set an explicit &gt; <code>Content-Type: text/plain</code> to make sure curl encodes the data correctly when there are special characters ('+' is particularly tricky).&gt;</p>
<p>åœ¨ server å¼€å¯äº†å¯†ç è¿æ¥åï¼ˆé€šè¿‡å¼•å…¥ spring-security å®ç°ï¼‰ï¼Œpost è¯·æ±‚ä¼šç”±äº csrf é˜²å¾¡è¢«æ‹¦æˆªï¼Œè¿”å› 401 é”™è¯¯ï¼Œä¸Šé¢çš„è¯·æ±‚å°±ä¸èƒ½ä½¿ç”¨äº†ï¼Œè§£å†³æ–¹æ³•æ˜¯å…³é—­ spring-security çš„ csrf é˜²å¾¡åŠŸèƒ½ã€‚è¿™é‡Œå°±ä¸æ”¹äº†ï¼Œå…³é—­æ‰ server çš„åŠ è§£å¯†ç«¯ç‚¹å¯¹äºå®‰å…¨è€ƒè™‘ä¹Ÿæ˜¯æŒºå¥½çš„ï¼Œæ”¹ç”¨ <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_encryption_and_decryption">spring cli</a>ã€‚</p>
<p><a href="https://github.com/spring-projects/spring-security/issues/7473">issue: https://github.com/spring-projects/spring-security/issues/7473</a></p>
<pre><code class="language-yaml"># è¯·æ±‚ä¸ä¼šæˆåŠŸ
$ curl user:password@localhost:7050/encrypt -d password -v
</code></pre>
<h3 id="åˆ·æ–°-client-é…ç½®-ç°åº¦å‘å¸ƒ"><a href="https://github.com/spring-cloud/spring-cloud-config#spring-cloud-config-client">åˆ·æ–° client é…ç½®ã€ç°åº¦å‘å¸ƒ</a></h3>
<p>åœ¨ä¸€äº›å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ·æ–° client çš„é…ç½®ï¼Œclient å¼•å…¥ <code>spring-boot-actuator-starter</code>Â  å³å¯<br>
client æ·»åŠ  actuator çš„é…ç½®ï¼Œå°† /refresh ç«¯ç‚¹æš´éœ²å‡ºæ¥</p>
<pre><code class="language-yaml">management:
  endpoints:
    enabled-by-default: true
    web:
      exposure:
      # è¿™é‡ŒæŒ‰éœ€é…ç½®
        include: health,info,refresh
      base-path: /actuator
  endpoint:
    health:
      show-details: always
</code></pre>
<p>åœ¨éœ€è¦åˆ·æ–°é…ç½®çš„ç±»ä¸Šæ·»åŠ  <code>@RefreshScope</code> æ³¨è§£</p>
<pre><code class="language-java">package com.wekj.ground.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;

@RestController
@RefreshScope
public class TestController {
    @Autowired
    private Environment environment;

    @Value(&quot;${foo:bar}&quot;)
    private String foo;

    @GetMapping(&quot;foo&quot;)
    public String getFoo() {
        return foo;
    }
}
</code></pre>
<p>è°ƒç”¨ actuator ç«¯ç‚¹è¿›è¡Œåˆ·æ–°ï¼š</p>
<pre><code>$ curl -X POST http://localhost:7010/actuator/refresh
{&quot;code&quot;:1,&quot;msg&quot;:&quot;æ“ä½œæˆåŠŸ!&quot;,&quot;data&quot;:[&quot;foo&quot;]}
</code></pre>
<p>è°ƒç”¨ /refresh åˆ·æ–° bean çš„æ—¶å€™ï¼Œä¼šå°†éœ€è¦åˆ·æ–°çš„ bean é”€æ¯æ‰ï¼Œä¸‹æ¬¡ä» bean factory é‡æ–°è·å– bean æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–ä¸€éã€‚<br>
ä¾èµ–äº†å¯åˆ·æ–° bean çš„ bean æ³¨å…¥çš„æ˜¯åˆ·æ–° bean çš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<h3 id="å¤šé…ç½®ç®¡ç†">å¤šé…ç½®ç®¡ç†</h3>
<h4 id="label-ç‰¹ç‚¹">label ç‰¹ç‚¹</h4>
<p><strong>label åº”è¯¥ç†è§£æˆé…ç½®çš„ç‰ˆæœ¬æ§åˆ¶ï¼ŒæŒ‡å®š label å°±æ˜¯æŒ‡å®šé…ç½®çš„å“ªä¸ªç‰ˆæœ¬</strong><br>
label å¯ä»¥æŒ‡å®šå¤šä¸ª labelï¼Œåœ¨æŒ‡å®šå¤šä¸ª label çš„æ—¶å€™ï¼Œä¼šä¸€ä¸ªä¸ªå°è¯•è·å–ç›¸å¯¹åº” label çš„é…ç½®ï¼Œç›´åˆ°ä¸€ä¸ª label æˆåŠŸä¸ºæ­¢ï¼Œè¿™åœ¨å¼€å‘ feature åˆ†æ”¯æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚<br>
ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼šå…ˆæŸ¥è¯¢ myfeature label æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯æ‹‰å–åˆ°é…ç½®å°±ä¼šåœæ­¢ï¼Œdevelop  çš„é…ç½®ä¼šè¢«æŠ›å¼ƒï¼Œå¦‚æœ myfeature ä¸å­˜åœ¨ï¼Œå°±ä¼šè·å– develop label çš„é…ç½®ã€‚</p>
<pre><code>spring.cloud.config.label=myfeature,develop
</code></pre>
<h4 id="å¤šé…ç½®æ–‡ä»¶æ–¹æ¡ˆ">å¤šé…ç½®æ–‡ä»¶æ–¹æ¡ˆ</h4>
<p>éœ€è¦æŒ‡å®šå¤šä¸ª profile çš„è¯è¿™æ ·é…ç½®åˆ° bootstrap.yml ä¸­</p>
<pre><code class="language-yaml">spring: 
  cloud:
    config:
      uri: http://localhost:7050
      label: local
      username: user
      password: password
      allowOverride: true
      overrideNone: true
      overrideSystemProperties: false
      # é…ç½®æ¿€æ´»çš„ profile
      profile: default,local
</code></pre>
<p>åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°† bootstrap.yml profile ä¸­æŒ‡å®šçš„é…ç½®æ‹‰å–ä¸‹æ¥ï¼Œå†ç»“åˆæœ¬åœ°çš„é…ç½®ã€‚<br>
åº”ç”¨å¯åŠ¨çš„é…ç½®æ¥æºäºä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯è·å–åˆ°çš„äº‘ç«¯é…ç½®ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°é…ç½®ï¼Œä¸¤æ¬¡è·å–éƒ½å¯ä»¥æŒ‡å®šéœ€è¦è·å–çš„ profileï¼Œä¸ä¼šè¦†ç›–ã€‚<br>
äº‘ç«¯æ— æ³•è¦†ç›–åº”ç”¨å¯åŠ¨æŒ‡å®šçš„ profileï¼Œåªèƒ½è·å– spring.cloud.config.profile å¯¹åº”çš„é…ç½®ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://jiangjinxinn.github.io//post-images/1587880963457.jpg" alt="" loading="lazy"></figure>
<h3 id="é…ç½®ç¼“å­˜">é…ç½®ç¼“å­˜</h3>
<p><a href="">é»˜è®¤ server ç«¯æ˜¯ä¸ä¼šç¼“å­˜è·å–åˆ°çš„é…ç½®çš„</a>ï¼Œclient ä¹Ÿä¸ä¼šæœ‰ç¼“å­˜</p>
<h4 id="server-ç«¯å¦‚ä½•ç¼“å­˜é…ç½®">server ç«¯å¦‚ä½•ç¼“å­˜é…ç½®</h4>
<p>client åˆ° sever è·å–é…ç½®çš„æ—¶å€™ï¼Œserver ä¼šä» git ä»“åº“è·å–ï¼Œserver é»˜è®¤æ˜¯æ¯æ¬¡è·å–é…ç½®éƒ½ä» git ä»“åº“è·å–ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®åšåˆ° server ç¼“å­˜é…ç½®åŠŸèƒ½</p>
<pre><code class="language-yaml"># å•ä½ sï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤º server æ¯æ¬¡è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„é…ç½®éƒ½ä»è¿œç¨‹ git ä»“åº“è·å–
spring.cloud.config.server.git.refreshRate=0
</code></pre>
<p>server æ˜¯å¦åˆ·æ–°ç¼“å­˜ä»£ç ï¼š<br>
<code>org.springframework.cloud.config.server.environment.JGitEnvironmentRepository#refresh</code></p>
<pre><code># server ç¼“å­˜å­˜æ”¾çš„ä½ç½®
spring.cloud.config.server.git.basedir=
</code></pre>
<p>server çš„ç¼“å­˜ä¼šåœ¨ server å…³é—­çš„æ—¶å€™åˆ é™¤æ‰ <code>org.springframework.cloud.config.server.support.AbstractScmAccessor#createBaseDir</code>Â <br>
<strong>åœ¨ server å¯åŠ¨åï¼Œgit è¿œç¨‹ä»“åº“è¿æ¥ä¸ä¸Šäº†ï¼Œè¿™æ—¶ä¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚</strong></p>
<h4 id="å®¢æˆ·ç«¯ç¼“å­˜é…ç½®">å®¢æˆ·ç«¯ç¼“å­˜é…ç½®</h4>
<p>client å¯åŠ¨çš„æ—¶å€™ä¼šå°† server è·å–åˆ°é…ç½®ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œåç»­ä» server è·å–é…ç½®çš„æ—¶å€™ï¼Œä¸ä¼šä½¿ç”¨&quot;ç¼“å­˜&quot;åœ¨å†…å­˜ä¸­çš„é…ç½®ã€‚</p>
<p>ç›¸å…³ä»£ç åœ¨ï¼š<br>
<code>org.springframework.cloud.config.client.ConfigServicePropertySourceLocator#locate</code><br>
<code>org.springframework.cloud.config.client.ConfigServicePropertySourceLocator#getRemoteEnvironment</code><br>
å¯ä»¥åœ¨ <code>getRemoteEnvironment</code> è¿™ä¸ªæ–¹æ³•ä¸­çœ‹åˆ°æ¯æ¬¡è·å–é…ç½®éƒ½æ˜¯å‘èµ· http è¯·æ±‚åˆ° server çš„ï¼Œè·å–ä¸åˆ°é…ç½®çš„è¯ï¼Œå†æ ¹æ®æ˜¯å¦é…ç½®äº†å¿«é€Ÿå¤±è´¥æŠ›å‡ºå¼‚å¸¸ã€‚<br>
<img src="https://jiangjinxinn.github.io//post-images/1587880251548.png" alt="" loading="lazy"></p>
<figure data-type="image" tabindex="2"><img src="https://jiangjinxinn.github.io//post-images/1587880212590.jpg" alt="" loading="lazy"></figure>
<h3 id="æœ¬åœ°å¼€å‘æ–¹æ¡ˆ">æœ¬åœ°å¼€å‘æ–¹æ¡ˆ</h3>
<h4 id="æœ¬åœ°å¼€å‘æ–¹æ¡ˆ-2">æœ¬åœ°å¼€å‘æ–¹æ¡ˆ</h4>
<p>1ã€éœ€è¦ä¿®æ”¹é…ç½®çš„è¯ï¼Œåœ¨é…ç½®ä»“åº“æ‹‰ feature åŒååˆ†æ”¯<br>
2ã€éªŒè¯æ— è¯¯åæäº¤merger requeståˆå¹¶åˆ°å¯¹åº”ç¯å¢ƒ</p>
<h4 id="å‘å¸ƒæµç¨‹">å‘å¸ƒæµç¨‹</h4>
<p>å»ºè®®ï¼šæœ¬åœ°å¼€å‘å¯ä»¥åªç•™ä¸‹ä¸€ä¸ª bootstrap.ymlï¼Œapplication.yml éƒ½å»æ‰</p>
<h3 id="serveré«˜å¯ç”¨-å®‰å…¨æ€§">serveré«˜å¯ç”¨ã€å®‰å…¨æ€§</h3>
<h4 id="client-å¥åº·æ£€æŸ¥">client å¥åº·æ£€æŸ¥</h4>
<p>æ£€æµ‹æ˜¯å¦èƒ½è¿æ¥ sever æˆåŠŸï¼Œé»˜æ‰“å¼€ï¼Œå¯ä»¥ä¸æ‰“å¼€ï¼Œå› ä¸ºåŠ¨æ€åˆ·æ–°éœ€æ±‚çš„å¾ˆå°‘ã€‚åº”ç”¨å¯åŠ¨æˆåŠŸåï¼Œserver down æ‰ä¹Ÿä¸å½±å“åº”ç”¨ã€‚</p>
<pre><code>health.config.enabled=false
# å¥åº·æ£€æŸ¥å‘¨æœŸé»˜è®¤ 5 åˆ†é’Ÿï¼Œå•ä½ ms
health.config.time-to-live=milliseconds
</code></pre>
<h4 id="client-å¯åŠ¨å¿«é€Ÿå¤±è´¥">client å¯åŠ¨å¿«é€Ÿå¤±è´¥</h4>
<p><strong>å¼ºçƒˆå»ºè®®æ‰“å¼€ï¼š</strong></p>
<pre><code>spring.cloud.config.fail-fast=true
</code></pre>
<p>æ‰“å¼€åå®¢æˆ·ç«¯å¿«é€Ÿå¤±è´¥åï¼Œåº”ç”¨å¯åŠ¨æ—¶ï¼Œå¦‚æœè¿æ¥ä¸ä¸Š server å°±ä¼šåœæ­¢å¯åŠ¨ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰æ‰“å¼€çš„ï¼Œè¿æ¥å¤±è´¥åªä¼šæ‰“å° warn æ—¥å¿—ã€‚<br>
åœ¨åº”ç”¨å¯åŠ¨æˆåŠŸåï¼Œå¦‚æœ server æŒ‚äº†ï¼Œåº”ç”¨æ˜¯ä¸ä¼šå—åˆ°å¿«é€Ÿå¤±è´¥å½±å“çš„ã€‚åœ¨åˆ·æ–°é…ç½®çš„æ—¶å€™ä¼šæç¤º server down äº†ã€‚</p>
<h4 id="client-å¯†ç è¿æ¥-server">client å¯†ç è¿æ¥ server</h4>
<p>server å¼•å…¥ <code>spring-security</code> çš„ starter</p>
<pre><code># ä¸é…ç½®çš„è¯é»˜è®¤æ˜¯ user
spring.security.user.name
# ä¸é…ç½®çš„è¯ä¼šéšæœºç”Ÿæˆä¸€ä¸ªå¯†ç 
spring.security.user.password
</code></pre>
<pre><code>$ curl user:password@localhost:7050/ground/default/master
</code></pre>
<p>config-client æŠŠå¯†ç é…ç½®åˆ° spring.cloud.config ä¸‹é¢</p>
<pre><code class="language-yaml">spring:
  application:
    name: ground
  cloud:
    config:
      uri: http://localhost:7050
      label: local
      fail-fast: true
      username: user
      password: password
</code></pre>
<ol>
<li>å¦‚æœè¿æ¥ server çš„å¯†ç é”™è¯¯ï¼Œå¯åŠ¨æŠ¥é”™ä¸ä¼šæç¤ºå¯†ç é”™è¯¯ï¼Œè€Œæ˜¯ä¸‹é¢çš„è¿™ä¸ªé”™è¯¯ï¼ˆæ‰“å¼€å¿«é€Ÿå¤±è´¥å¾ˆæœ‰å¿…è¦ï¼‰</li>
</ol>
<pre><code>java.lang.IllegalStateException: Could not locate PropertySource and the fail fast property is set, failing
	at org.springframework.cloud.config.client.ConfigServicePropertySourceLocator.locate(ConfigServicePropertySourceLocator.java:148) ~[spring-cloud-config-client-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.bootstrap.config.PropertySourceLocator.locateCollection(PropertySourceLocator.java:52) ~[spring-cloud-context-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.config.client.ConfigServicePropertySourceLocator.locateCollection(ConfigServicePropertySourceLocator.java:163) ~[spring-cloud-config-client-2.2.2.RELEASE.jar:2.2.2.RELEASE]
	at org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration.initialize(PropertySourceBootstrapConfiguration.java:97) ~[spring-cloud-context-2.2.2.RELEASE.jar:2.2.2.RELEASE]
</code></pre>
<h4 id="server-å¯åŠ¨é…ç½®æ¥è‡ª-config">server å¯åŠ¨é…ç½®æ¥è‡ª config</h4>
<p>å¦‚æœé€‰æ‹©å†…åµŒåœ¨ springboot åº”ç”¨ä¸­å¯åŠ¨ serverï¼Œå¯ä»¥ä½¿ server çš„é…ç½®ä¹Ÿä» git æ‹‰å–<br>
<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_embedding_the_config_server">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.2.RELEASE/reference/html/#_embedding_the_config_server</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Netty å¢å¼ºå†™ FlushConsolidationHandler]]></title>
        <id>https://jiangjinxinn.github.io/post/netty-zeng-qiang-xie/</id>
        <link href="https://jiangjinxinn.github.io/post/netty-zeng-qiang-xie/">
        </link>
        <updated>2020-02-06T06:33:13.000Z</updated>
        <content type="html"><![CDATA[<p>å¦‚æœè¿½æ±‚ååé‡ï¼Œå¯ä»¥ä¸ç”¨ ctx.writeAndFlush()ï¼Œè¿™ç§å†™æ•°æ®æ˜¯åœ¨æ¯æ¬¡ write åéƒ½ç«‹å³ flushï¼ŒåŠ æ€¥å†™æ•°æ®ã€‚</p>
<p>åœ¨ FlushConsolidationHandler ç±»çš„æ³¨é‡Šä¸Šæœ‰è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼š</p>
<blockquote>
<p>Flush operations are generally speaking expensive as these may trigger a syscall on the transport level. Thus it is in most cases (where write latency can be traded with throughput) a good idea to try to minimize flush operations as much as possible.</p>
</blockquote>
<p><strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªå¢å¼ºå†™çš„ Netty çš„ FlushConsolidationHandleræ¥å¤„ç†è¿™ä¸ªäº‹æƒ…ï¼Œè¿™ä¸ª Handler æœ‰ä¸€ä¸ªå‚æ•° explicitFlushAfterFlushes å¯ä»¥æ§åˆ¶æ‹¦æˆªå‡ æ¬¡ flush åæ‰è¿›è¡ŒçœŸæ­£çš„ flushæ“ä½œã€‚</strong></p>
<p>è¿™é‡Œæåˆ° FlushConsolidationHandler å¯ä»¥æ‹¦æˆªï¼Œé‚£ä¹ˆä¸ç”¨æƒ³ï¼Œè‚¯å®šæ˜¯ç»§æ‰¿äº† ChannelDuplexHandlerã€‚</p>
<p>è¿™é‡Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æ·»åŠ  FlushConsolidationHandler è®¾å®šäº† explicitFlushAfterFlushes ä¹‹åçœ‹ï¼Œå¦‚æœ flush æ¬¡æ•°ä¸å¤Ÿéš¾é“å°±ä¸€ç›´ä¸ flush å‡ºå»äº†ï¼Œéœ€è¦ç­‰åˆ°åè¾¹ä¸€æ¬¡è¯·æ±‚è¿›æ¥çš„å‡ºç«™äº‹ä»¶åˆ°æ¥å flush å¤Ÿäº†æ‰èƒ½å†™å—ï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜è‚¯å®šä¸æ˜¯çš„ï¼Œå¦‚æœæ˜¯çš„è¯å°±æ˜¯ä¸ªä¸¥é‡çš„ç¼ºé™·çš„ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ FlushConsolidationHandler æºç æ¥è¯´æ˜ä¸‹</p>
<p>å…³é”®ç‚¹åœ¨ flush æ–¹æ³•ä¸Šï¼Œéœ€è¦è¯´æ˜çš„æ˜¯åœ¨ä»»æ„ä¸€ä¸ª ctx ä¸Šæ‰§è¡Œ flush çš„æ—¶å€™ï¼Œä¼šæ ¹æ® pipeline ä¸Šè®¾ç½®çš„ ChannelHandlerContextï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ª outBoundHandler ä¼ é€’ä¸‹å»ï¼Œåˆ° FlushConsolidationHandler æ—¶å€™å°±ä¼šè¢«æ‹¦æˆªä¸‹æ¥</p>
<pre><code>@Override
public void flush(ChannelHandlerContext ctx) throws Exception {
    if (readInProgress) {
        // If there is still a read in progress we are sure we will see a channelReadComplete(...) call. Thus
        // we only need to flush if we reach the explicitFlushAfterFlushes limit.
        if (++flushPendingCount == explicitFlushAfterFlushes) {
            flushNow(ctx);
        }
    } else if (consolidateWhenNoReadInProgress) {
        // Flush immediately if we reach the threshold, otherwise schedule
        if (++flushPendingCount == explicitFlushAfterFlushes) {
            flushNow(ctx);
        } else {
            scheduleFlush(ctx);
        }
    } else {
        // Always flush directly
        flushNow(ctx);
    }
}
</code></pre>
<p>Netty æºç ä¸Šçš„æ³¨è§£å·²ç»å¾ˆå¥½çš„è¯´æ˜äº†ï¼Œæœ‰ä¸€ä¸ªå˜é‡ readInProgress æ ‡è¯†æ˜¯å¦æ­£åœ¨è¯»ï¼ˆå³è¯»äº‹ä»¶æœªç»“æŸï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸æŸ¥çœ‹ consolidateWhenNoReadInProgress è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æœ readInProgress æ ‡è®°æ­£åœ¨è¯» FlushConsolidationHandler å°±ä¼šè¿›è¡Œç»§ç»­è¿›è¡Œæ‹¦æˆªï¼Œç›´åˆ° flush æ¬¡æ•°æ»¡è¶³äº†åæ‰ä¼šè¿›è¡Œæœ€åçš„ flushï¼Œè¯»äº‹ä»¶å·²ç»ç»“æŸçš„è¯ç›´æ¥è°ƒç”¨æœ€åçš„ flush</p>
<p>è¿™å°±è§£ç­”äº†ä¸Šé¢çš„é—®é¢˜ï¼Œå¦‚æœ flush æ¬¡æ•°ä¸å¤Ÿï¼Œä½†æ˜¯è¯»äº‹ä»¶å·²ç»ç»“æŸäº†ï¼Œä¾ç„¶ä¼šè¿›è¡Œ flushã€‚</p>
<p>è¿™æ—¶ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ„Ÿè§‰è¿™ä¸ª FlushConsolidationHandler æ²¡ä»€ä¹ˆç”¨ï¼Œå› ä¸ºä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘åªè¦ä¸è°ƒç”¨ ctx.writeAndFlush() å³å¯ï¼Œåªè°ƒç”¨ ctx.write ()ï¼Œç„¶åå†æœ€å flush æ‰ã€‚</p>
<p>å¯¹çš„ï¼Œè¿™ä¸ªåœ¨ Netty çš„å®˜æ–¹ demo ä¸­å°±æ˜¯è¿™æ ·å®ä¾‹çš„ï¼Œåªåœ¨è¯»äº‹ä»¶ç»“æŸåæ‰è¿›è¡Œ ctx.flush()</p>
<pre><code>/**
 * Handler implementation for the echo server.
 */
@Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ctx.write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<p>é‚£ä¹ˆè¿™ä¸ª FlushConsolidationHandler æ˜¯æ€ä¹ˆä½¿ç”¨çš„å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ª FlushConsolidationHandler ä¸»è¦æ˜¯åœ¨å¼‚æ­¥å†™ï¼ˆåœ¨ handler ä¸Šæ·»åŠ äº†çº¿ç¨‹æ± ï¼‰çš„æ—¶å€™ä½¿ç”¨çš„ï¼Œæ‹¦æˆªå¤šæ¬¡å¼‚æ­¥å†™å³é€šè¿‡å‰é¢ consolidateWhenNoReadInProgress æ¥æ§åˆ¶ï¼Œè€Œä¸”ä¸ºäº†é˜²æ­¢å¼‚æ­¥å†™æœªæ‰§è¡Œå¤Ÿè®¾å®šçš„ explicitFlushAfterFlushes ï¼Œä¼šæ·»åŠ ä¸€ä¸ª future æ¥è¿›è¡Œè°ƒç”¨æœ€åçš„ flush</p>
<p>å› ä¸º Netty çš„çº¿ç¨‹æ¨¡å‹æ˜¯ä¸€ä¸ª pipeline ç»‘å®šä¸€ä¸ªåŒä¸€ä¸ª eventLoopï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¹¶å‘æ‰§è¡Œçš„é—®é¢˜ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤šä¸ªè¯»äº‹ä»¶åœ¨ä¸€ä¸ª pipeline ä¸Šå‘ç”Ÿï¼Œåœ¨åŒä¸€æ¬¡è¯»äº‹ä»¶æœªç»“æŸä¹‹å‰ï¼ˆæœªè°ƒç”¨channelReadComplete ä¹‹å‰ï¼‰ éƒ½ä¼šæ˜¯ readInProgress trueï¼Œä¿è¯ flush çš„æ‰§è¡Œå¯ä»¥åœ¨è¯»äº‹ä»¶å¤„ç†å®Œåè¿›è¡Œï¼Œå¦‚æœè¯»äº‹ä»¶ç»“æŸäº†ï¼Œå°±å¯ä»¥ç›´æ¥ flush å‡ºå»ã€‚</p>
<p>ä½†æ˜¯åœ¨ä¸€ä¸ª pipeline ä¸Šçš„è¯»äº‹ä»¶å®Œæˆäº†ä¸å¸¦è¡¨çœŸæ­£çš„è¯»äº‹ä»¶å®Œæˆäº†ï¼Œå¦‚æœè¯»äº‹ä»¶æ˜¯åœ¨å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ± çš„ä¸šåŠ¡çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè™½ç„¶å½“å‰ pipelin ä¸Šçš„è¯»äº‹ä»¶å·²ç»è¿”å›äº†ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡æœ‰è°ƒç”¨ writeAndFlushã€‚<br>
consolidateWhenNoReadInProgress å‚æ•°çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†åº”å¯¹è¿™ç§é—®é¢˜ã€‚</p>
<p>çœ‹ä¸‹å®ä¾‹çš„å¼‚æ­¥å†™æƒ…å†µï¼š</p>
<pre><code>UnorderedThreadPoolEventExecutor eventExecutors = new UnorderedThreadPoolEventExecutor(10);
try {
    serverBootstrap.group(boss, worker)
            .handler(new LoggingHandler(LogLevel.INFO))
            .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() {
                protected void initChannel(NioSocketChannel ch) throws Exception {
                    ChannelPipeline pipeline = ch.pipeline();

                    pipeline.addLast(new ServerIdleCheckHandler());
                    pipeline.addLast(&quot;frameDecoder&quot;, new FrameDecoder());
                    pipeline.addLast(&quot;frameEncoder&quot;, new FrameEncoder());

                    pipeline.addLast(&quot;protocolEncoder&quot;, new ProtocolEncoder());
                    pipeline.addLast(&quot;protocolDecoder&quot;, new ProtocolDecoder());


                    pipeline.addLast(new LoggingHandler(LogLevel.INFO));
                    pipeline.addLast(eventExecutors, &quot;serviceHandler&quot;, serviceDispatchHandler);

                }
            });
    ChannelFuture sync = serverBootstrap.bind(8098).sync();
</code></pre>
<p>pipeline.addLast(eventExecutors, &quot;serviceHandler&quot;, serviceDispatchHandler); å…³é”®åœ¨è¿™è¡Œä»£ç </p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[# 2019]]></title>
        <id>https://jiangjinxinn.github.io/post/2019/</id>
        <link href="https://jiangjinxinn.github.io/post/2019/">
        </link>
        <updated>2020-01-25T07:33:16.000Z</updated>
        <content type="html"><![CDATA[<p>ç½‘ä¸Šçœ‹äº†äº›å¹´ç»ˆæ€»ç»“ï¼Œå¤§å¤šæ•°è¿˜æ˜¯æ‰“å¹¿å‘Šæ€§è´¨çš„ï¼Œè®²è¿°ä¸‹è‡ªå·±è¿™ä¸€å¹´å¹²äº†å•¥ï¼Œä½œä¸ºè®ºè¿°ä¸‹è‡ªå·±å¾ˆç‰›é€¼çš„è¯æ®ï¼Œç¡®å®ï¼Œä¸€çœ¼çœ‹ä¸‹æ¥æ„Ÿè§‰ä»–ä»¬è¾“å‡ºçœŸçš„ç‰›é€¼ï¼Œæš—æš—å’Œè‡ªå·±å¯¹æ¯”äº†ä¸‹ï¼Œå¿ƒé‡Œæ³›èµ·äº†å˜€å’•ï¼Œå’‹äººä¸äººä¹‹é—´å·®è·è¿™ä¹ˆå¤§å‘¢?</p>
<p>æˆ‘åœ¨ä»¥å‰çœ‹åˆ°è‡ªå·±å†™çš„ç¬”è®°å’Œæ—¥è®°æ—¶éƒ½ä¼šæƒ³è¦åˆ æ‰å®ƒä»¬ï¼Œå¿ƒé‡Œè¿˜è¦ç–‘é—®ä¸‹ï¼Œè¿™ä¸ªå‚»é€¼æ˜¯æˆ‘ï¼Ÿæ…¢æ…¢çš„ä½“ä¼šåˆ°æ—¶é—´é£é€ï¼Œç•™ä¸‹æ¥ä¸€äº›è®°å½•ä¹ŸæŒºæœ‰æ„æ€çš„ï¼Œå‚»é€¼çš„è‡ªå·±ä¹Ÿæ˜¯è‡ªå·±ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡æ€»ç»“ã€‚</p>
<hr>
<p>æƒ³æ¥ä» 2018 å¹´ 6 æœˆæ¯•ä¸šè‡³ä»Šé©¬ä¸Šå°±è¦å·¥ä½œä¸¤å¹´äº†ï¼Œå’Œæ¯æ¬¡å›æƒ³ä»¥å‰çš„äº‹ä¸€æ ·ï¼Œéƒ½ä¼šæ„Ÿå¹æ—¶é—´è¿‡çš„ä¹‹å¿«ã€‚</p>
<p>æ„Ÿè§‰ç°åœ¨æŠ€æœ¯æ°´å¹³ç®—æ˜¯å…¥äº†ä¸ªé—¨å§ï¼Œä»åˆšå¼€å§‹æ¥å…¬å¸çš„æ—¶å€™ï¼Œidea ç”¨ä¸æ¥ï¼Œä¸Šç½‘æŸ¥æ•™ç¨‹åˆ°ç°åœ¨ä¸Šç½‘æŸ¥çœ‹é¢è¯•é¢˜ï¼Œå­¦ä¹ çš„è¿‡ç¨‹å°±æ˜¯è¿™ä¸ªæ ·å­å§ã€‚</p>
<p>æƒ³èµ·ç¬¬ä¸€æ¬¡çœ‹åˆ°ç»„é•¿ä»£ç é‡Œç”¨ BeanUtils çš„ copyProperties æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°åŒäº‹ç”¨ ApplicationContextAware æ—¶å€™çš„æƒŠè®¶ï¼Œçœ‹åˆ°åŒäº‹å°è£… react å†™ä¸ªç±»çš„æ—¶å€™ï¼Œçœ‹åˆ°å…¬å¸å†…éƒ¨ä½¿ç”¨çš„æ¡†æ¶æ˜¯ä¸»ç®¡å†™çš„æ—¶å€™ï¼Œæˆ‘å°å°çš„å†…å¿ƒéƒ½è¢«éœ‡æ’¼äº†ã€‚æœ‰ä¸€æ¬¡å¬åˆ°éš”å£ç»„çš„åŒäº‹è¯´åˆ†å¸ƒå¼é”çš„æ—¶å€™ï¼Œæ›´æ˜¯æµ‘èº«æŠ–æ“äº†ä¸€ä¸‹ï¼Œå¤ªç‰›é€¼äº†ï¼Œå¿ƒé‡Œä¸æ–­çš„å‘å‡ºæ„Ÿå¹ã€‚</p>
<p>ç„¶åå°±æ˜¯ç¨³æ­¥è¿›è¡Œä¸­çš„æ¬ç –äº‹ä¸šï¼Œè¢« react å‰ç«¯åŠæ‰“çš„è¿‡ç¨‹ï¼Œä» java åŸºç¡€å¼€å§‹æ¶è¡¥çŸ¥è¯†ã€‚</p>
<p>å°è±¡æ›´æ·±çš„å°±æ˜¯ä»Šå¹´å¹´ä¸­çš„æ—¶å€™ç»„é‡Œæ¥äº†ä¸ªå®ä¹ ç”Ÿï¼Œæƒ³ä¸‹åŒæœŸçš„è‡ªå·±åœ¨å¹²å•¥ï¼Œæ›´åŠ æ„Ÿè§‰è‡ªå·±å¤ªèœäº†ï¼Œè¿˜è¦åŠ æŠŠåŠ²ï¼Œä½†æ€»åˆæ„Ÿè§‰æœ‰ç‚¹å¥‡æ€ªï¼Œç®—æ¥ä¹Ÿ 25 å²äº†ï¼Œå’‹è¿˜è¦æ¯å¤©å­¦ä¹ ã€‚ã€‚</p>
<p>å¹´ä¸­ä»¥åæ¢äº†ä¸ªç»„ï¼Œå¼€å§‹å†™ç‚¹è¶…å‡ºæˆ‘æ°´å¹³çš„ä»£ç ï¼Œå†™éƒ½å†™ä¸æ¥ï¼Œåªèƒ½å»æŠ„ä»£ç ã€‚ã€‚çœ‹ nacos ä»£ç çš„æ—¶å€™ï¼Œè¢«ä»£ç é‡Œçš„å¿ƒè·³è¿æ¥æƒŠè‰³äº†ï¼Œé¡¿æ—¶æ„Ÿè§‰è‡ªå·±ä¹‹å‰ä¸çŸ¥é“åœ¨å¹²å•¥ï¼Œæ†¨æ†¨çš„ä¸€æ ·ã€‚å¥½åœ¨è™½ç„¶é¡¹ç›®è¶…æ—¶äº†ï¼Œç»„é•¿ä¹Ÿåªèƒ½èƒŒåå˜€å’•ä¸‹è¶…æ—¶äº†è¶…æ—¶äº†ï¼Œä¹Ÿä¸ä¼šè¯´å•¥ã€‚ã€‚ã€‚</p>
<p>æ…¢æ…¢å¿ƒé‡Œè§‰å¾—å…¬å¸ low çš„æ„Ÿè§‰è¶Šæ¥è¶Šå¼ºçƒˆï¼Œcode review éƒ½æ²¡æœ‰å•Šï¼Œè¿˜è¦è€æ˜¯å¼ºè°ƒä»£ç è§„èŒƒï¼ŒåŒäº‹ maven æ‰“ä¸ª jar åŒ…éƒ½è€æ˜¯ç¿»è½¦å‘æˆ‘ï¼Œä»€ä¹ˆæƒ…å†µå•Šã€‚å…¬å¸çš„æ–‡åŒ–ä¹Ÿè¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œç†Ÿæ‚‰åéšä¹‹è€Œæ¥çš„æ˜¯æœ‰ç‚¹å¤±æœ›ã€‚</p>
<p>è¿™ä¸€å¹´ç»©æ•ˆä¹Ÿä¸å¥½çœ‹ï¼Œå¿ƒæ€æ—¶å¸¸çˆ†ç‚¸ã€‚å¥½åœ¨ç°åœ¨èƒ½ç¨³çš„ä½äº†ã€‚</p>
<p>æˆ‘å¸Œæœ›è¿™é‡Œå°±ç®—åšæ˜¯å¯¹äº‹å®çš„æè¿°ï¼Œè€Œä¸æ˜¯æŠ±æ€¨ï¼Œæ¯•ç«ŸæŠ±æ€¨ä¸èƒ½è§£å†³é—®é¢˜ï¼Œä¹Ÿæ²¡äººä¼šå–œæ¬¢è´Ÿèƒ½é‡ã€‚ä½†è¿™é‡Œè¿˜æ˜¯ä¼šå¦‚å®çš„è®°å½•ä¸‹æˆ‘åé¢å¯¹å…¬å¸çš„çœ‹æ³•ï¼Œä¸åšä¿®é¥°ã€‚</p>
<hr>
<p>æ€»çš„æ¥è¯´ï¼Œæˆ‘è§‰å¾—æˆ‘è¿˜æ˜¯å¹¸è¿çš„ï¼Œåœ¨å…¬å¸çš„æ—¶å€™ä¸»è¦è¿˜æ˜¯åœ¨å­¦ä¹ ï¼Œæœ‰æ—¶å¹²äº›è¶…å‡ºè‡ªå·±æ°´å¹³çš„äº‹ã€‚æ›´éš¾èƒ½å¯è´µçš„æ˜¯å¿ƒæ€å¾—åˆ°äº†é”»ç‚¼ï¼Œè¿™ç§è´¢å¯Œè¿˜æ˜¯æ›´åŠ çè´µçš„ã€‚</p>
<p>æƒ³èµ·ä¸»ç®¡å¯¹æˆ‘è¯´ï¼Œæœ‰äº›ä¸œè¥¿åªæœ‰ä½ åœ¨ä¸€å®¶å…¬å¸å¾…çš„è¶³å¤Ÿä¹…æ‰ä¼šæ˜ç™½ã€‚æˆ‘è§‰å¾—æˆ‘æ˜ç™½äº†ä¸€äº›äº†ï¼Œä½†æˆ‘ä¸èƒ½ç¡®å®šæ˜¯ä¸æ˜¯ä»–æ‰€è¯´æ˜ç™½çš„ä¸œè¥¿ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Netty å¯¹ Reactor æ¨¡å¼å¸¸è§çš„ç–‘é—®]]></title>
        <id>https://jiangjinxinn.github.io/post/netty-dui-reactor-mo-shi-chang-jian-de-yi-wen/</id>
        <link href="https://jiangjinxinn.github.io/post/netty-dui-reactor-mo-shi-chang-jian-de-yi-wen/">
        </link>
        <updated>2019-12-15T12:34:10.000Z</updated>
        <content type="html"><![CDATA[<h2 id="netty-å¦‚ä½•æ”¯æŒä¸»ä»-reactor-æ¨¡å¼">Netty å¦‚ä½•æ”¯æŒä¸»ä» Reactor æ¨¡å¼</h2>
<p>ç®€å•æ¥è¯´å°±æ˜¯å°† ä¸¤ç§ channel æ³¨å†Œåˆ°ä¸¤ç§ EventLoopGroupä¸Šã€‚<br>
ä¸»è¦çš„é€»è¾‘åœ¨ å¼•å¯¼ç±» <code>ServerBootstrap</code> çš„ group() ä¸­é…ç½®äº† BossGroup å’Œ WorkGroupï¼Œä¼šåœ¨åé¢ register() å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚</p>
<p>ServerBootstrap.group() æ–¹æ³•:</p>
<pre><code class="language-java">/**
 * Specify the {@link EventLoopGroup} which is used for the parent (acceptor) and the child (client).
 */
@Override
public ServerBootstrap group(EventLoopGroup group) {
    // â‘  éä¸»ä»çš„ Reactor æ¨¡å¼ï¼Œä¸€ä¸ª group å¹²ä¸¤ä¸ªæ´»
    return group(group, group);
}

/**
 * Set the {@link EventLoopGroup} for the parent (acceptor) and the child (client). These
 * {@link EventLoopGroup}'s are used to handle all the events and IO for {@link ServerChannel} and
 * {@link Channel}'s.
 */
// ä¸»ä»æ¨¡å¼çš„ group é…ç½®
public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup) {
    // â‘¡ è®¾ç½® parentGroup å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ boss group 
    super.group(parentGroup);
    if (childGroup == null) {
        throw new NullPointerException(&quot;childGroup&quot;);
    }
    if (this.childGroup != null) {
        throw new IllegalStateException(&quot;childGroup set already&quot;);
    }
    // â‘¢ è®¾ç½® childGroup å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ worker group
    this.childGroup = childGroup;
    return this;
}
</code></pre>
<p>å…ˆçœ‹ä¸‹æ­¥éª¤ â‘¡ è®¾ç½®äº† parentGroup åçš„åŠ¨ä½œã€‚<br>
åœ¨ <code>AbstractBootstrap#initAndRegister</code> åˆå§‹åŒ–ä¸­ä¼šå°†åé¢çš„ <code>ServerSocketChannel</code> æ³¨å†Œåˆ° parent gorup ä¸Šã€‚</p>
<pre><code class="language-java">final ChannelFuture initAndRegister() {
    Channel channel = null;
    try {
        channel = channelFactory.newChannel();
        // âœ…child groupåœ¨è¿™é‡Œåˆå§‹åŒ–
        init(channel);
    } catch (Throwable t) {
        if (channel != null) {
            // channel can be null if newChannel crashed (eg SocketException(&quot;too many open files&quot;))
            channel.unsafe().closeForcibly();
        }
        // as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
        return new DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);
    }
    // âœ… ServerSocketChannel åœ¨è¿™é‡Œæ³¨å†Œåˆ° parent group ä¸Š
    ChannelFuture regFuture = config().group().register(channel);
    if (regFuture.cause() != null) {
        if (channel.isRegistered()) {
            channel.close();
        } else {
            channel.unsafe().closeForcibly();
        }
    }
    return regFuture;
}
</code></pre>
<p>æ¥ç€æ¥çœ‹ä¸‹æ­¥éª¤ â‘¢ ä¸­è®¾ç½® childGroup åçš„æ“ä½œï¼Œå¦‚ä¸Šé¢è´´çš„ä»£ç å¯ä»¥çœ‹åˆ°åœ¨<code>AbstractBootstrap#initAndRegister</code> åŒæ—¶ä¹Ÿåˆå§‹åŒ–äº† childGroup çš„æ“ä½œ</p>
<pre><code class="language-java">void init(Channel channel) throws Exception {
    final Map&lt;ChannelOption&lt;?&gt;, Object&gt; options = options0();
    synchronized (options) {
        setChannelOptions(channel, options, logger);
    }

    final Map&lt;AttributeKey&lt;?&gt;, Object&gt; attrs = attrs0();
    synchronized (attrs) {
        for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: attrs.entrySet()) {
            @SuppressWarnings(&quot;unchecked&quot;)
            AttributeKey&lt;Object&gt; key = (AttributeKey&lt;Object&gt;) e.getKey();
            channel.attr(key).set(e.getValue());
        }
    }

    ChannelPipeline p = channel.pipeline();
    // â‘  childGroup æ¢äº†ä¸€ä¸ªåå­—
    final EventLoopGroup currentChildGroup = childGroup;
    final ChannelHandler currentChildHandler = childHandler;
    final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;
    final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;
    synchronized (childOptions) {
        currentChildOptions = childOptions.entrySet().toArray(newOptionArray(childOptions.size()));
    }
    synchronized (childAttrs) {
        currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(childAttrs.size()));
    }

    p.addLast(new ChannelInitializer&lt;Channel&gt;() {
        @Override
        public void initChannel(final Channel ch) throws Exception {
            final ChannelPipeline pipeline = ch.pipeline();
            ChannelHandler handler = config.handler();
            if (handler != null) {
                pipeline.addLast(handler);
            }

            ch.eventLoop().execute(new Runnable() {
                @Override
                public void run() {
                    // â‘¡ ä¼ é€’ç»™ ServerBootstrapAcceptor
                    pipeline.addLast(new ServerBootstrapAcceptor(
                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));
                }
            });
        }
    });
</code></pre>
<p>åœ¨ â‘¡ ä¸­å°† childGroup ä¼ é€’ç»™äº† <code>ServerBootstrapAcceptor</code>ï¼Œ ä»–å…¶å®æ˜¯ä¸ª <code>ChannelInboundHandlerAdapter</code>ï¼Œåœ¨ä»–çš„é‡å†™æ–¹æ³•<code>ServerBootstrap.ServerBootstrapAcceptor#channelRead</code>ä¸­å°†åç»­æ”¶åˆ°çš„ <code>SocketChannel</code> æ³¨å†Œåˆ° childGroup ä¸Š</p>
<pre><code class="language-java">@Override
@SuppressWarnings(&quot;unchecked&quot;)
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    // â‘  è¿™ä¸ª msg å°±æ˜¯ SocketChannel
    final Channel child = (Channel) msg;

    child.pipeline().addLast(childHandler);

    setChannelOptions(child, childOptions, logger);

    for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) {
        child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());
    }

    try {
        // â‘¡ æ³¨å†Œåˆ° childGroup ä¸Š
        childGroup.register(child).addListener(new ChannelFutureListener() {
            @Override
            public void operationComplete(ChannelFuture future) throws Exception {
                if (!future.isSuccess()) {
                    forceClose(child, future.cause());
                }
            }
        });
    } catch (Throwable t) {
        forceClose(child, t);
    }
}
</code></pre>
<h2 id="ä¸ºä»€ä¹ˆè¯´-netty-çš„-main-reactor-å¤§å¤šå¹¶ä¸èƒ½ç”¨åˆ°ä¸€ä¸ªçº¿ç¨‹ç»„åªèƒ½çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª">ä¸ºä»€ä¹ˆè¯´ Netty çš„ main reactor å¤§å¤šå¹¶ä¸èƒ½ç”¨åˆ°ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œåªèƒ½çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª</h2>
<p>å› ä¸ºå¤§å¤šåªç»‘å®šä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å°±åªç”¨åˆ°çº¿ç¨‹ç»„é‡Œé¢çš„ä¸€ä¸ª<br>
<code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p>
<h2 id="netty-ç»™-channel-åˆ†é…-nio-event-loop-çš„è§„åˆ™æ˜¯ä»€ä¹ˆ">Netty ç»™ Channel åˆ†é… NIO event loop çš„è§„åˆ™æ˜¯ä»€ä¹ˆ</h2>
<p>å¯¹äº NIO çš„ EventLoopGroup çš„å®ç°æ˜¯<code>MultithreadEventLoopGroup#register(io.netty.channel.Channel)</code></p>
<pre><code class="language-java">    @Override
    public ChannelFuture register(Channel channel) {
        // è¿™é‡Œçš„ next() æ˜¯ä¸ªé€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ä¸ª EventExecutor
        return next().register(channel);
    }
</code></pre>
<p>æœ€åæ˜¯åœ¨ <code>EventExecutorChooserFactory</code> çš„ç­–ç•¥æ¨¡å¼ä¸­é€‰æ‹©ä¸€ä¸ª <code>EventExecutor</code>ï¼Œ</p>
<pre><code class="language-java">/**
 * Factory that creates new {@link EventExecutorChooser}s.
 */
@UnstableApi
public interface EventExecutorChooserFactory {

    /**
     * Returns a new {@link EventExecutorChooser}.
     */
    EventExecutorChooser newChooser(EventExecutor[] executors);

    /**
     * Chooses the next {@link EventExecutor} to use.
     */
    @UnstableApi
    interface EventExecutorChooser {

        /**
         * Returns the new {@link EventExecutor} to use.
         */
        EventExecutor next();
    }
}
</code></pre>
<p>æœ‰ä¸¤ä¸ªå®ç°ç±»ä¸€ä¸ªæ˜¯<code>GenericEventExecutorChooser</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>PowerOfTwoEventExecutorChooser</code>ï¼ŒåŒºåˆ«åœ¨äºé€‰æ‹©ä¸€ä¸‹ä¸ª<code>EventExecutor</code>æ—¶å€™ï¼Œå¦‚æœæ˜¯2çš„å¹‚æ¬¡ï¼Œå¯ä»¥ç›´æ¥æŒ‰ä¸ºä¸ <code>&amp;</code> æ“ä½œï¼Œé«˜æ•ˆä¸€ç‚¹ã€‚</p>
<h2 id="netty-å¦‚ä½•å®ç°å¤šè·¯å¤ç”¨å™¨è·¨å¹³å°çš„">Netty å¦‚ä½•å®ç°å¤šè·¯å¤ç”¨å™¨è·¨å¹³å°çš„</h2>
<p>Netty çš„ NIO Selector å°è£…åœ¨ <code>NioEventLoopGroup</code> ä¸­</p>
<pre><code class="language-java">public NioEventLoopGroup(int nThreads, Executor executor) {
    this(nThreads, executor, SelectorProvider.provider());
}
</code></pre>
<p>é€šè¿‡ <code>SelectorProvider.provider()</code> è·å–ç›¸åº”çš„Selectorã€‚</p>
<pre><code class="language-java">public static SelectorProvider provider() {
    synchronized (lock) {
        if (provider != null)
            return provider;
        return AccessController.doPrivileged(
            new PrivilegedAction&lt;SelectorProvider&gt;() {
                public SelectorProvider run() {
                        // â‘  ä»ç³»ç»Ÿå‚æ•°ä»è·å– nio selector çš„ spi å®ç°
                        if (loadProviderFromProperty())
                            return provider;
                        // â‘¡ é€šè¿‡ java spi åŠ è½½
                        if (loadProviderAsService())
                            return provider;
                        // â‘¢ jdk å®ç°
                        provider = sun.nio.ch.DefaultSelectorProvider.create();
                        return provider;
                    }
                });
    }
}   
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œnio çš„ selector è·å–æœ‰ä¸‰ç§é€”å¾„ï¼Œä¸€èˆ¬æœ€åå°±æ˜¯ sun çš„ jdk ä¸­çš„å®ç°ã€‚åœ¨ mac ä¸­æ˜¯ <code>KQueueSelectorProvider</code>ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Sublime éšæ‰‹è®°]]></title>
        <id>https://jiangjinxinn.github.io/post/sublime-sui-shou-ji/</id>
        <link href="https://jiangjinxinn.github.io/post/sublime-sui-shou-ji/">
        </link>
        <updated>2019-12-08T08:05:25.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ“ƒå®ç°ä¸€ä¸ªä¸ä¼šæç¤ºä¿å­˜çš„ Sublime éšæ‰‹è®°</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ“ƒå®ç°ä¸€ä¸ªä¸ä¼šæç¤ºä¿å­˜çš„ Sublime éšæ‰‹è®°</p>
<!-- more -->
<figure data-type="image" tabindex="1"><img src="https://jiangjinxinn.github.io//post-images/1575792658471.jpg" alt="è®©äººå¿ƒçƒ¦çš„æç¤ºä¿å­˜" loading="lazy"></figure>
<p>çœ‹åˆ°ä¸Šé¢çš„æç¤ºæ¡†ï¼Œæˆ‘å¤´å¾ˆå¤§ã€‚å¹³æ—¶ç»å¸¸ ctrl + n æ–°å»ºä¸€ä¸ªé¡µé¢å¤åˆ¶ä¸€äº›æ–‡æœ¬ï¼Œè¿›è¡Œå¯¹æ¯”æˆ–è€…æŸ¥çœ‹ï¼Œä½†æ˜¯åœ¨å…³é—­æ–‡ä»¶çš„æ—¶å€™ä¼š Sublime æç¤ºä½ ä¿å­˜ï¼Œæ—¥ç§¯æœˆç´¯ä¸‹æ¥å°±æœ‰ç‚¹çƒ¦äº†ã€‚</p>
<p>æ‰€ä»¥é¡¹æ‰¾ä¸‹åŠæ³•æŠŠ Sublime æ”¹æˆè‰ç¨¿çº¸ï¼Œè®© ctrl + n æ–°å»ºçš„é¡µé¢ç¼–è¾‘å…³é—­åä¸æç¤ºä¿å­˜ã€‚</p>
<hr>
<p>Sublime ç›¸å…³æ’ä»¶æœäº†ä¸€ä¼™å„¿æ²¡æœ‰å‘ç°ï¼Œåˆ° Stack Overflow ä¸Šæœäº†ä¸‹ï¼Œæ‰¾åˆ°äº†ä¸€äº›æ–¹æ³•ã€‚</p>
<p><a href="https://stackoverflow.com/questions/24663013/sublime-text-prompt-to-save-file">sublimetext2 - Sublime Text Prompt to Save File - Stack Overflow</a></p>
<p><a href="https://forum.sublimetext.com/t/request-dont-prompt-to-save-empty-untitled-tabs/685">Request: Donâ€™t prompt to save empty â€œuntitledâ€ tabs - Ideas and Feature Requests - Sublime Forum</a></p>
<hr>
<p>æŒ‰ç…§ Stack Overflow ä¸Šçš„æ–¹æ³•ç”¨äº†ä¸‹ï¼Œå¾ˆå¥½ï¼Œå¾ˆæ»¡æ„ï¼Œæ–°åˆ›å»ºçš„æ–‡æ¡£ä¼šè¢«æ ‡è®°ä¸ºè‰ç¨¿æ–‡ä»¶ï¼Œä¿®æ”¹åä¸ä¼šæç¤ºä¿å­˜ã€‚ä¿®æ”¹å·²å­˜åœ¨çš„æ–‡ä»¶ä»ç„¶è¿˜æœ‰æç¤ºä¿å­˜ã€‚</p>
<p>Stack Overflow ä¸Šçš„ä»£ç æœ‰ä¸ªåœ°æ–¹è¦æ”¹ä¸‹</p>
<pre><code class="language-python">class SetNewScratchBuffer(sublime_plugin.EventListener):
    def on_new(self, view):
        view.set_scratch(True)

    def on__save(self, view):
        view.set_scratch(False)
</code></pre>
<p><code>on_save</code> éœ€è¦æ”¹æˆ <code>on_pre_save</code>ã€‚åœ¨ <a href="http://www.sublimetext.com/docs/3/api_reference.html#sublime_plugin.EventListener">Sublime API Reference</a> æ²¡æœ‰çœ‹åˆ° <code>on_save</code> çš„ä¿¡æ¯ã€‚</p>
<p>è¿˜æœ‰ä¸ª bugï¼Œè¿›ç¨‹é€€å‡ºå¯åŠ¨ Sublime åœ¨é»˜è®¤çš„ untitled æ–‡ä»¶ä¸Šä¸ä¼šç”Ÿæ•ˆï¼Œä½†æ˜¯ä¸é€€å‡ºè¿›ç¨‹çš„è¯ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“æ˜¯å¦æ˜¯ Sublime çš„ bugã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Stream ç”Ÿæˆå‹¾è‚¡æ•°]]></title>
        <id>https://jiangjinxinn.github.io/post/stream-sheng-cheng-gou-gu-shu/</id>
        <link href="https://jiangjinxinn.github.io/post/stream-sheng-cheng-gou-gu-shu/">
        </link>
        <updated>2019-11-06T14:01:33.000Z</updated>
        <content type="html"><![CDATA[<p>çªç„¶æƒ³èµ·å»å¹´çœ‹çš„ã€Šjava8 å®æˆ˜ã€‹ä¸Šçš„ç”¨ Stream ç”Ÿæˆå‹¾è‚¡æ•°çš„ä¾‹å­ã€‚è¿™é‡Œè¯•ä¸€ä¸‹ã€‚<br>
å…³é”®åœ¨äº flatMap å’Œç”Ÿæˆå…ˆè¿›è¡Œè¿‡æ»¤å†ç”Ÿæˆæ•°ç»„ï¼Œè™½ç„¶è®¡ç®—äº†ä¸¤æ¬¡å¼€æ–¹ï¼Œä½†æ˜¯ç”Ÿæˆæ•°ç»„çš„å¼€é”€æ›´å¤§ã€‚</p>
<pre><code class="language-java">import java.util.stream.IntStream;
import java.util.stream.Stream;

class Scratch {
    public static void main(String[] args) {
        long start = System.currentTimeMillis();
        Stream&lt;int[]&gt; pythagoreanTriple = IntStream.rangeClosed(1, 100).boxed()
                .flatMap(a -&gt; IntStream.rangeClosed(a, 100)
                        .filter(b -&gt; Math.sqrt(a * a + b * b) % 1 == 0)
                        .mapToObj(b -&gt; new int[]{a, b, (int) Math.sqrt(a * a + b * b)}));

        pythagoreanTriple.limit(10).forEach(t -&gt; System.out.println(t[0] + &quot; &quot; + t[1] + &quot; &quot; + t[2]));
        long end = System.currentTimeMillis();
        System.out.println(&quot;total time: &quot; + (end - start) + &quot;\n&quot;);


        long start2 = System.currentTimeMillis();
        Stream&lt;int[]&gt; pythagoreanTriple2 = IntStream.rangeClosed(1, 100).boxed()
                .flatMap(a -&gt; IntStream.rangeClosed(a, 100)
                        .mapToObj(b -&gt; new int[]{a, b, (int) Math.sqrt(a * a + b * b)}))
                        .filter(t -&gt; Math.sqrt(t[2]) % 1 == 0);

        pythagoreanTriple2.limit(10).forEach(t -&gt; System.out.println(t[0] + &quot; &quot; + t[1] + &quot; &quot; + t[2]));
        long end2 = System.currentTimeMillis();
        System.out.println(&quot;total time 2: &quot; + (end2 - start2) + &quot;\n&quot;);
    }
}
</code></pre>
<p>è¿è¡Œçš„ç»“æœ</p>
<pre><code>3 4 5
5 12 13
6 8 10
7 24 25
8 15 17
9 12 15
9 40 41
10 24 26
11 60 61
12 16 20
total time: 91

1 1 1
1 4 4
1 9 9
1 16 16
1 25 25
1 36 36
1 49 49
1 64 64
1 81 81
1 100 100
total time 2: 3


Process finished with exit code 0
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[leetcode-cn.com ui ä¿®æ”¹]]></title>
        <id>https://jiangjinxinn.github.io/post/leetcode-cncom-ui-xiu-gai/</id>
        <link href="https://jiangjinxinn.github.io/post/leetcode-cncom-ui-xiu-gai/">
        </link>
        <updated>2019-11-02T14:51:04.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ç¼˜èµ·">ç¼˜èµ·</h2>
<p>ç”±äºçœ‹åˆ° leetcode ä¸­å›½ç‰ˆæ›´æ–°äº†æ–°çš„ä»£ç ç¼–è¾‘å™¨å’Œé•¿ä¹…ä»¥æ¥åœ¨ leetcode ç¾å›½ç‰ˆç½‘ç»œæœ‰æ—¶ä¸é¡ºç•…ï¼Œå†³å®šè¿åˆ°ä¸­å›½ç‰ˆä¸Šæ¥ã€‚</p>
<p>è¿™æ—¶å€™å°±ç¢°åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸­å›½ç‰ˆæ”¹äº†åšé¢˜åŒºçš„ uiï¼Œçœ‹ç€æ„Ÿè§‰éå¸¸çš„éš¾å—ï¼Œä¸ä¹ æƒ¯ã€‚</p>
<p>ç¾å›½ç‰ˆçš„åšé¢˜åŒºçš„å¤´éƒ¨æ ‡é¢˜åŒºç­‰æµ‘ç„¶ä¸€ä½“ååˆ†è‡ªç„¶<br>
<img src="https://jiangjinxinn.github.io//post-images/1572706485835.png" alt="" loading="lazy"></p>
<p>ä¸­å›½ç‰ˆæ ‡é¢˜åŒºå•ç‹¬ä¸Šç§»å‡ºæ¥ï¼Œæœ€é‡è¦çš„æ˜¯è¾¹æ¡†ä¸åº•ä¸‹éƒ¨åˆ†åŠ äº†é˜´å½±ï¼Œæ„Ÿè§‰éå¸¸çš„å¥‡æ€ªã€‚<br>
<img src="https://jiangjinxinn.github.io//post-images/1572706501580.png" alt="" loading="lazy"></p>
<h2 id="åŠ¨æ‰‹æ”¹ä¸€ä¸‹">åŠ¨æ‰‹æ”¹ä¸€ä¸‹</h2>
<p>å®‰è£… chrome çš„æ‰©å±•æ’ä»¶ <a href="https://chrome.google.com/webstore/detail/stylus/clngdbkpkpeebahjckkjfobafhncgmne?hl=zh-CN">Stylus</a></p>
<blockquote>
<p>Stylus æ˜¯ä¸€ä¸ªè°ƒæ•´ç½‘é¡µå¤–è§‚çš„ç”¨æˆ·æ ·å¼ç®¡ç†å™¨ã€‚å®ƒå¯è®©æ‚¨è½»æ¾åœ°ä¸ºè®¸å¤šçƒ­é—¨ç½‘ç«™ç½‘ç«™å®‰è£…ä¸»é¢˜å’Œçš®è‚¤ã€‚</p>
</blockquote>
<p>ç‚¹å‡»ç¼–å†™æ ·å¼<br>
<img src="https://jiangjinxinn.github.io//post-images/1572707096588.png" alt="" loading="lazy"></p>
<p>æ·»åŠ  css æ ·å¼ä¿®æ”¹ä¸‹</p>
<pre><code class="language-css">[class*=&quot;HeaderCn&quot;] {
    box-shadow: none
}

[class*=&quot;ant-dropdown-menu-item&quot;] a[href]::after {
    display: none
}

[class*=&quot;NavbarListItem&quot;] a[href]::after {
    display: none
}

[class*=&quot;StyledBanner&quot;] {
    display: none
}
</code></pre>
<h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2>
<p>é˜´å½±å»æ‰åçœ‹èµ·æ¥å°±èˆ’æœå¤šã€‚é¡ºå¸¦å¯¼èˆªæ ä¸Šèœå•æ–‡å­—åé¢çš„ newã€hot ä¹Ÿä¸€èµ·å¤„ç†æ‰äº†ã€‚<br>
<img src="https://jiangjinxinn.github.io//post-images/1572708099346.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é¢è¯•ï¼ˆ2019 å¹´ 10 æœˆï¼‰]]></title>
        <id>https://jiangjinxinn.github.io/post/mian-shi-2019-nian-10-yue/</id>
        <link href="https://jiangjinxinn.github.io/post/mian-shi-2019-nian-10-yue/">
        </link>
        <updated>2019-11-01T20:07:54.000Z</updated>
        <content type="html"><![CDATA[<h2 id="we-å…¬å¸">we å…¬å¸</h2>
<p>10 æœˆ 18æ—¥</p>
<p>ç°åœºé¢ï¼ˆåˆè®¡hr é¢ 2 å°æ—¶ 15 åˆ†ï¼‰</p>
<p>é¢è¯•å®˜ 1:</p>
<ol>
<li>çœ‹è¿‡å“ªäº›æºç ï¼Ÿ</li>
<li>spring bean ç”Ÿå‘½å‘¨æœŸ</li>
<li>å‡è®¾ä¸€ä¸ªç±» A å¦‚ä¸‹ï¼ŒbeanFactory ä¸­æœ‰ä¸¤ä¸ªç±»å‹çš„ Carï¼ŒbeanId ä¸º carAï¼ŒcarBï¼Œä¸‹é¢ç±»ä¸­ä¸­ Carèƒ½å¦æ³¨å…¥æˆåŠŸï¼Œ å¦‚ä½•è®© car çš„æ³¨å…¥åŠ¨æ€åŒ–</li>
</ol>
<pre><code>class A {
    @Resource
    private Car someCar;
    
    public someMethod(Car someCar) {
        // sout
    }
}
</code></pre>
<ul>
<li>å¦‚ä½•å®ç°ä¸€ä¸ª LRU ç®—æ³•</li>
<li>å†™ä¸‹é€’å½’ n çš„é˜¶å±‚</li>
<li>java ä¸­ juc åŒ…ä¸‹å“ªäº›é”æ˜¯ cas æ“ä½œï¼Ÿ</li>
<li>synchronized å’Œå¯é‡å…¥é”ï¼ŒJMMã€volatile</li>
<li>mysql æ ¹æ®æ€§åˆ«æŸ¥è¯¢ä¸åŒçš„ç”¨æˆ·æ€ä¹ˆåŠ ç´¢å¼•</li>
<li>mysql ç´¢å¼•</li>
<li>æµè§ˆå™¨åœ°å€æ è¾“å…¥ç½‘å€åçš„è¿‡ç¨‹</li>
<li>èŠäº†ä¸‹è®¾è®¡æ¨¡å¼</li>
<li>èŠäº†ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡</li>
<li>äº§å“ç»ç†æ¯”è¾ƒçƒ‚æ€ä¹ˆåŠ</li>
</ul>
<p>é¢è¯•å®˜ 2ï¼š</p>
<ul>
<li>react çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>webpack ç”¨è¿‡æ²¡</li>
<li>zookeeper ä¸€è‡´æ€§åŸç†äº†ï¼Œzookeeper æ ¸å¿ƒåŸç†æ˜¯å•¥</li>
<li>æœ‰æ²¡æœ‰é«˜å¹¶å‘ç»éªŒ</li>
<li>å®ç°ä»¥ä¸‹ä»£ç ï¼Œæ¨¡ä»¿ConcurrentHashMap çš„computeIfAbsentï¼Œä½†æ˜¯è¦æ±‚åŒæ ·çš„ key å’Œ mappingFunctionåŒæ—¶è¯·æ±‚çš„æ—¶å€™åªè®¡ç®—ä¸€æ¬¡ï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹</li>
</ul>
<pre><code>public class ConcurrentHashMap {
    public V computeIfAbsent(K key,
            Function&lt;? super K, ? extends V&gt; mappingFunction) {
        /**
        /* è¦æ±‚ mappingFunction åªè®¡ç®—ä¸€æ¬¡ï¼Œå³åŒæ · keyã€mappingFunction 
        /* è°ƒç”¨çš„æ—¶å€™åªè®¡ç®—ä¸€æ¬¡,mappingFunction,é˜»å¡å¦ä¸€ä¸ªçº¿ç¨‹çš„è°ƒç”¨
        */
    }
}
</code></pre>
<h2 id="yz-å…¬å¸">yz å…¬å¸ï¼š</h2>
<p>ç”µè¯é¢ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰<br>
2. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†åº“åˆ†è¡¨<br>
3. è§£é‡Šä¸‹ä¸€æ¡ sql åœ¨åˆ†åº“åˆ†è¡¨ä¸‹æ˜¯æ€ä¹ˆæŸ¥è¯¢çš„<br>
4. é¡¹ç›®ä¸­ mq ç”¨æ¥å¹²å˜›çš„<br>
5. mq æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆå¤„ç†<br>
6. inodb ç´¢å¼•<br>
7. éš”ç¦»çº§åˆ«<br>
8. mvccï¼Œéš”ç¦»çº§åˆ«æ€ä¹ˆå®ç°çš„<br>
9. è®²ä¸‹ä¸€è‡´æ€§è§†å›¾<br>
10. è¡Œé”</p>
<h2 id="dd-å…¬å¸">dd å…¬å¸</h2>
<p>ç”µè¯é¢ï¼ˆçº¦ 1 å°æ—¶ 10 åˆ†ï¼‰</p>
<ol>
<li>ç”¨æˆ·æ‰“åˆ†ç®—æ³• bm5ï¼ˆå¬ä¸æ¸…å«å•¥äº†ï¼‰äº†è§£å¦</li>
<li>å¹¶å‘é‡æœ‰å¤šå°‘ï¼Œè¯·æ±‚é‡å¤šå°‘</li>
<li>å¾®æœåŠ¡ç”¨çš„ä»€ä¹ˆæ¡†æ¶</li>
<li>ç®€å†ä¸Šçš„æ ¡éªŒæ¡†æ¶å¹²å˜›çš„ï¼Œæœ‰ä»€ä¹ˆéš¾ç‚¹</li>
<li>ä»‹ç»ä¸‹ dubbo
<ol>
<li>dubbo ä¸»è¦åˆ†å±‚</li>
<li>æ³¨å†Œä¸­å¿ƒæŒ‚äº†è¿˜èƒ½è°ƒç”¨å—</li>
<li>è®²è¿°ä¸‹æœåŠ¡ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚çš„è¿‡ç¨‹</li>
<li>åºåˆ—åŒ–æœºåˆ¶æœ‰å“ªäº›</li>
<li>å®ç° dubbo æ‰©å±•æœºåˆ¶ spi è¦æ·»åŠ å“ªäº›ç±»</li>
<li>åºåˆ—åŒ–å®ç°äº†è§£å—ï¼Œä¸ºä»€ä¹ˆé€‰ç”¨ hessian</li>
<li>è´Ÿè½½å‡è¡¡æœºåˆ¶æœ‰å“ªäº›</li>
<li>è®©ä½ æ¥è®¾è®¡ä¸€ä¸ª rpc æ¡†æ¶ï¼Œå¦‚ä½•è®¾è®¡</li>
</ol>
</li>
<li>mysql ç´¢å¼•ã€mvcc</li>
<li>å¹¶å‘ç›¸å…³</li>
<li>
<ol>
<li>volatile è¯­ä¹‰ï¼Œä½¿ç”¨åœºæ™¯ã€JMM
<ol>
<li>sychronized åŸç†ã€è®²è¿°ä¸‹é”ä¼˜åŒ–ã€é”è†¨èƒ€</li>
<li>å¯é‡å…¥é”å’Œè¯»å†™é”</li>
<li>çº¿ç¨‹æ± åŒ…ä¸‹ä¸»è¦æœ‰å“ªäº›ç±»ï¼Œä¸»è¦æ˜¯æ€ä¹ˆè®¾è®¡çš„</li>
<li>çº¿ç¨‹æ± ä¸­çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›</li>
<li>ConcurrentHashMap</li>
</ol>
</li>
</ol>
</li>
<li>æœ‰æ²¡æœ‰ç¢°åˆ°è¿‡ oomã€sql ä¼˜åŒ–ç»éªŒ</li>
<li>redis
<ol>
<li>äº‹åŠ¡äº†è§£å—</li>
<li>ç®¡é“æ“ä½œäº†è§£å—</li>
<li>æœ‰å“ªäº›æ•°æ®ç»“æ„</li>
<li>é›†ç¾¤</li>
</ol>
</li>
<li>Spring Boot</li>
<li>
<ol>
<li>è®²è¿°ä¸‹ä½ çš„ç†è§£ï¼Œå’Œ Spring æœ‰å“ªäº›åŒºåˆ«
<ol>
<li>æ¡ä»¶è£…é…æ€ä¹ˆå®ç°çš„</li>
<li>å¦‚ä½•å®ç°ä¸€ä¸ª SpringBoot Starter</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="mk-å…¬å¸">mk å…¬å¸</h2>
<p>ç°åœºé¢ï¼ˆåˆè®¡hr é¢çº¦ 2 å°æ—¶ 30 åˆ†ï¼‰</p>
<p>é¢è¯•å®˜ 1ï¼š</p>
<ul>
<li>Hashmapã€ConcurrentHashMap
<ul>
<li>HashMap å¹¶å‘ç¯å¢ƒä¸‹æœ‰ä»€ä¹ˆé—®é¢˜</li>
<li>ä¸ºä»€ä¹ˆä½¿ç”¨çº¢é»‘æ ‘</li>
<li>çº¢é»‘æ ‘ crud å“ªä¸ªæ“ä½œæœ€å¿«</li>
</ul>
</li>
<li>JVM å†…å­˜åŒº
<ul>
<li>ä»‹ç»ä¸‹å¸¸é‡æ± </li>
<li>å †ä¸­å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º gc-roots</li>
<li>è®²è¿°ä¸‹ç±»åŠ è½½è¿‡ç¨‹</li>
</ul>
</li>
<li>Sychronized
<ul>
<li>è®²ä¸€ä¸‹é”è†¨èƒ€å¦‚ä½•å®ç°</li>
<li>JMM å†…å­˜æ¨¡å‹</li>
</ul>
</li>
<li>çº¿ç¨‹æ± å‚æ•°
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸æœ€å¤§çº¿ç¨‹æ•°çš„åŒºåˆ«</li>
<li>å·¥ä½œé˜Ÿåˆ—æœ‰å“ªå‡ ç§</li>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°æ»¡äº†ä»¥åæ·»åŠ æ–°ä»»åŠ¡å¦‚ä½•å¤„ç†çš„</li>
<li>ä»»åŠ¡æ‹’ç»ç­–ç•¥æœ‰å“ªäº›</li>
</ul>
</li>
<li>BeanFactory ä¸ FactoryBean çš„åŒºåˆ«</li>
<li>è®²ä¸€ä¸‹ mysql ç´¢å¼•
<ul>
<li>è”åˆç´¢å¼•ï¼ˆA,B,C) æŸ¥è¯¢ï¼ˆB,C) èƒ½å¦ä½¿ç”¨ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</li>
<li>è®²ä¸€ä¸‹mysql ç´¢å¼•ä½¿ç”¨éœ€è¦æ³¨æ„çš„åœ°æ–¹</li>
<li>ç´¢å¼•åº•å±‚æ•°æ®ç»“æ„</li>
<li>ä¸ºä»€ä¹ˆä½¿ç”¨ b+æ ‘</li>
</ul>
</li>
<li>Dubbo äº†è§£å—
<ul>
<li>è´Ÿè½½å‡è¡¡æœ‰å“ªäº›ç­–ç•¥</li>
<li>ä¸€è‡´æ€§ hash åŸç†</li>
</ul>
</li>
<li>ThreadLocal ä½¿ç”¨è¿‡å—
<ul>
<li>ThreadLocal æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li>
<li>æ€ä¹ˆå®ç°çš„</li>
</ul>
</li>
<li>Redis
<ul>
<li>String æ•°æ®ç»“æ„æ˜¯å¦‚ä½•å®ç°çš„</li>
<li>è®²ä¸‹è·³è¡¨</li>
<li>å¤‡ä»½ç­–ç•¥</li>
<li>ä¸»ä»åŒæ­¥</li>
</ul>
</li>
</ul>
<p>é¢è¯•å®˜ 2ï¼š</p>
<ul>
<li>è®¾è®¡æ¨¡å¼
<ul>
<li>è®¾è®¡æ¨¡å¼æœ‰å“ªäº›åŸåˆ™</li>
<li>ç­–ç•¥æ¨¡å¼</li>
<li>æ¨¡æ¿æ–¹æ³•</li>
</ul>
</li>
<li>æ•°æ®ç»“æ„
<ul>
<li>éå†å›¾æœ‰å‡ ç§æ–¹å¼</li>
</ul>
</li>
<li>æœ‰æ²¡æœ‰ oom è¿‡</li>
<li>è€å¹´ä»£çš„å¯¹è±¡çš„å¹´é¾„éƒ½ä¸å¤§æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿå¦‚ä½•è°ƒä¼˜ï¼Ÿ</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Nacos æœåŠ¡åˆ é™¤å¤±è´¥çš„é—®é¢˜]]></title>
        <id>https://jiangjinxinn.github.io/post/nacos-fu-wu-shan-chu-shi-bai-de-wen-ti/</id>
        <link href="https://jiangjinxinn.github.io/post/nacos-fu-wu-shan-chu-shi-bai-de-wen-ti/">
        </link>
        <updated>2019-10-14T06:12:22.000Z</updated>
        <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨ Nacos ä½œä¸ºæœåŠ¡ç›‘æ§çš„åŠŸèƒ½çš„æ—¶å€™å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼š<br>
åˆ é™¤æœåŠ¡æç¤ºå¤±è´¥ï¼š<br>
<img src="https://jiangjinxinn.github.io//post-images/1571033820491.png" alt="" loading="lazy"></p>
<p>æç¤ºæ˜¯å¯¹åº”çš„æœåŠ¡ä¸å­˜åœ¨<br>
ä½†æ˜¯å®é™…ä¸Š nacos çš„åå°ç®¡ç†é¡µé¢ä¸Šæ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”æˆ‘çš„åå°é¡µé¢ä¸Šè¿˜å‡ºç°äº†ä¸¤ä¸ªåŒåçš„æœåŠ¡ï¼Œå…¶ä¸­ä¸€ä¸ªå¯ä»¥åˆ é™¤æˆåŠŸï¼Œå¦ä¸€ä¸ªä¼šæŠ¥æœåŠ¡ä¸å­˜åœ¨</p>
<p>å›å¿†äº†ä¸‹æˆ‘ä¹‹å‰çš„æ“ä½œï¼Œå…¶ä¸­ä¸€æ¬¡åœ¨æ³¨å†ŒæœåŠ¡å®ä¾‹çš„æ—¶å€™ï¼Œåœ¨æœåŠ¡ååé¢å¸¦ä¸Šäº† <code>@@</code>ï¼ŒåŠ è¿™ä¸ªåŸå…ˆæ˜¯ä¸ºäº†åšæœåŠ¡åŒºåˆ†ç”¨çš„ï¼Œç”¨<code>@@</code> å­—ç¬¦æ˜¯å› ä¸ºæˆ‘åœ¨ nacos çš„æºç ä¸­çœ‹åˆ°ä»–ä»¬æ˜¯ç”¨ group + <code>@@</code> + serviceName ä½œä¸º service çš„æ ‡è¯†çš„ï¼Œæƒ³æ¨¡ä»¿ä¸€æ³¢ï¼Œè´´è¿‘é£æ ¼ã€‚ã€‚ã€‚</p>
<p>ç›´æ¥åˆ°ä»£ç ä¸­æ‰¾åŸå› ï¼Œå…ˆæ‰¾åˆ°æŠ›å‡ºå¼‚å¸¸çš„åœ°æ–¹<br>
<code>com.alibaba.nacos.naming.core.ServiceManager#easyRemoveService</code></p>
<pre><code>    public void easyRemoveService(String namespaceId, String serviceName) throws Exception {

        Service service = getService(namespaceId, serviceName);
        if (service == null) {
            // è¿™é‡ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå°±æ˜¯ï¼Œservice ä¸ºæ²¡æœ‰æŸ¥è¯¢åˆ°
            throw new IllegalArgumentException(&quot;specified service not exist, serviceName : &quot; + serviceName);
        }

        if (!service.allIPs().isEmpty()) {
            throw new IllegalArgumentException(&quot;specified service has instances, serviceName : &quot; + serviceName);
        }

        consistencyService.remove(KeyBuilder.buildServiceMetaKey(namespaceId, serviceName));
    }
</code></pre>
<p>è·å– service çš„æ–¹æ³•åœ¨è¿™ä¸ªæ¥å£ä¸­<br>
<code>com.alibaba.nacos.naming.core.ServiceManager#getService</code></p>
<pre><code>    public Service getService(String namespaceId, String serviceName) {
        if (serviceMap.get(namespaceId) == null) {
            return null;
        }
        // è¿™é‡Œç›´æ¥ä» map ä¸­æŸ¥è¯¢ key ä¸ºserviceName çš„ Service
        return chooseServiceMap(namespaceId).get(serviceName);
    }
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å°±æ˜¯åˆ°å­˜å‚¨äº† service çš„ concurrentHashMap ä¸­æŸ¥è¯¢ service</p>
<pre><code>    /**
     * Map&lt;namespace, Map&lt;group::serviceName, Service&gt;&gt;
     */
    private Map&lt;String, Map&lt;String, Service&gt;&gt; serviceMap = new ConcurrentHashMap&lt;&gt;();
</code></pre>
<p>è¿™é‡Œæ²¡æœ‰æŸ¥è¯¢åˆ°ï¼Œè¯´æ˜ serviceMap æ²¡æœ‰å­˜å‚¨äº†ç›¸åº”çš„é”®å€¼å¯¹æ•°æ®</p>
<p>serviceMap ä¸­æ²¡æœ‰å­˜å–æ•°æ®ï¼Œé‚£æ§åˆ¶åå°ä¸Šæ˜¾ç¤ºçš„æœåŠ¡å®ä¾‹æ•°æ®æ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿä» controller çš„æ¥å£ä¸ŠæŸ¥çœ‹ä¸‹<br>
<code>com.alibaba.nacos.naming.controllers.CatalogController#listDetail</code></p>
<pre><code>  @RequestMapping(value = &quot;/services&quot;, method = RequestMethod.GET)
    public Object listDetail(HttpServletRequest request) {

        boolean withInstances = Boolean.parseBoolean(WebUtils.optional(request, &quot;withInstances&quot;, &quot;true&quot;));

        if (withInstances) {
            String namespaceId = WebUtils.optional(request, CommonParams.NAMESPACE_ID,
                Constants.DEFAULT_NAMESPACE_ID);
            List&lt;ServiceDetailInfo&gt; serviceDetailInfoList = new ArrayList&lt;&gt;();
            int pageNo = Integer.parseInt(WebUtils.required(request, &quot;pageNo&quot;));
            int pageSize = Integer.parseInt(WebUtils.required(request, &quot;pageSize&quot;));
            String keyword = WebUtils.optional(request, &quot;keyword&quot;, StringUtils.EMPTY);

            List&lt;Service&gt; serviceList = new ArrayList&lt;&gt;(8);
            // æ§åˆ¶å°ä¸Šè¿”å›å¸¦æ•°æ®æ¥è‡ªè¿™é‡Œï¼ŒserviceList ä¼ å…¥serviceManager.getPagedService æ–¹æ³•ä¸­è¢«å¡«å……äº†æ•°æ®
            // åå°ç•Œé¢ä¸Šæœ‰æ•°æ®ï¼Œè¯´æ˜è¿™é‡Œè¿”å›äº†æ•°æ®ï¼Œç»§ç»­å¾€ä¸‹çœ‹ä¸‹
            serviceManager.getPagedService(namespaceId, pageNo, pageSize, keyword, StringUtils.EMPTY, serviceList, false);

            for (Service service : serviceList) {
                ServiceDetailInfo serviceDetailInfo = new ServiceDetailInfo();
                // è¿™é‡Œå°† Service çš„åå­—è¿›è¡Œäº†è½¬åŒ–ï¼Œå°±æ˜¯ä¹‹å‰è¯´çš„ï¼ŒserviceName æ˜¯ group + serviceNameï¼Œè¿™é‡Œè¦æŠŠ group å»æ‰
                serviceDetailInfo.setServiceName(NamingUtils.getServiceName(service.getName()));
                serviceDetailInfo.setGroupName(NamingUtils.getGroupName(service.getName()));
                serviceDetailInfo.setMetadata(service.getMetadata());

                Map&lt;String, ClusterInfo&gt; clusterInfoMap = getStringClusterInfoMap(service);
                serviceDetailInfo.setClusterMap(clusterInfoMap);

                serviceDetailInfoList.add(serviceDetailInfo);
            }

            return serviceDetailInfoList;
        } else {
            return serviceList(request);
        }
    }
</code></pre>
<p>è¿›å…¥åˆ° <code>NamingUtils</code> ä¸­çœ‹ä¸‹å…·ä½“æ˜¯å¦‚ä½•æŠŠ group å»æ‰ï¼Œè¿›è¡Œ name è½¬åŒ–çš„ã€‚</p>
<pre><code>public class NamingUtils {

    public static String getGroupedName(String serviceName, String groupName) {
        return groupName + Constants.SERVICE_INFO_SPLITER + serviceName;
    }

    public static String getServiceName(String serviceNameWithGroup) {
        if (!serviceNameWithGroup.contains(Constants.SERVICE_INFO_SPLITER)) {
            return serviceNameWithGroup;
        }
        // public static final String SERVICE_INFO_SPLITER = &quot;@@&quot;;
        // è¿™é‡Œæ˜¯é€šè¿‡ç›´æ¥å°†å­—ç¬¦ä¸²æŒ‰ &quot;@@&quot; åˆ†å‰²ï¼Œè¿”å›æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœæœåŠ¡çš„åå­—å¸¦æœ‰`@@`ï¼Œ`@@` ä¼šè¢«å»æ‰
        return serviceNameWithGroup.split(Constants.SERVICE_INFO_SPLITER)[1];
    }

    public static String getGroupName(String serviceNameWithGroup) {
        if (!serviceNameWithGroup.contains(Constants.SERVICE_INFO_SPLITER)) {
            return Constants.DEFAULT_GROUP;
        }
        return serviceNameWithGroup.split(Constants.SERVICE_INFO_SPLITER)[0];
    }
}
</code></pre>
<p>ä» <code>NamingUtils</code> å¯ä»¥çœ‹å‡ºï¼Œè¿”å›å‰å°ç•Œé¢çš„æ—¶å€™è¦å°†åˆå¹¶çš„æ•°æ®ï¼ŒæŒ‰<code>@@</code> åˆ†å‰²äº†ï¼Œè·å–åˆ°æœåŠ¡å¯¹åº”çš„ groupã€‚</p>
<p>æœ€åçœ‹ä¸‹å­˜å…¥ service ä¿¡æ¯çš„æ—¶å€™ï¼Œæ˜¯å¦å¦‚æ‰€é¢„æƒ³çš„é‚£æ ·ï¼Œservice çš„ name å’Œ group åˆå¹¶åæ²¡æœ‰åšå¤„ç†çš„ã€‚<br>
<code>com.alibaba.nacos.naming.core.ServiceManager</code></p>
<pre><code>    public void putService(Service service) {
        if (!serviceMap.containsKey(service.getNamespaceId())) {
            synchronized (putServiceLock) {
                if (!serviceMap.containsKey(service.getNamespaceId())) {
                    serviceMap.put(service.getNamespaceId(), new ConcurrentHashMap&lt;&gt;(16));
                }
            }
        }
        // å¯ä»¥çœ‹åˆ°å­˜å…¥ service çš„æ—¶å€™ï¼Œåå­—æ²¡æœ‰åšå¤„ç†
        serviceMap.get(service.getNamespaceId()).put(service.getName(), service);
    }
</code></pre>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>nacos çš„æœåŠ¡å¯ä»¥åˆ†ç»„ï¼Œå¦‚æ–‡æ¡£æ‰€è¯´ï¼Œæ¨¡å‹æ˜¯ service --&gt; cluster --&gt; insttanceï¼Œcluster å°±æ˜¯ä»£ç ä¸­çš„ groupã€‚åœ¨å®é™…çš„ä»£ç å±‚é¢ä¸Šå¤„ç†çš„æ—¶å€™ï¼Œæ˜¯å°† service å’Œ cluster åˆå¹¶æˆä¸€ä¸ªå±æ€§ï¼Œç”¨ <code>@@</code> åšåˆ†å‰²ã€‚</p>
<pre><code class="language-java">/**
 * Service of Nacos server side
 * &lt;p&gt;
 * We introduce a 'service --&gt; cluster --&gt; instance' model, in which service stores a list of clusters,
 * which contain a list of instances.
 * &lt;p&gt;
 * This class inherits from Service in API module and stores some fields that do not have to expose to client.
 *
 * @author nkorange
 */
</code></pre>
<p>è¿™é‡Œæ‰¾åˆ°æœåŠ¡åˆ é™¤ä¸æ‰ï¼ŒåŸå› å°±æ˜¯å‰é¢æ‰€è¯´çš„ï¼Œæˆ‘ä¹‹å‰æµ‹è¯•çš„æ—¶å€™ï¼Œå‡ºäºä¸€äº›åŸå› ï¼ˆæ†¨ï¼‰ï¼Œåœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™<br>
<code>com.alibaba.nacos.api.naming.NamingService#registerInstance(java.lang.String, com.alibaba.nacos.api.naming.pojo.Instance)</code><br>
æ³¨å†Œçš„æœåŠ¡çš„åå­—åé¢å¸¦ä¸Šäº†<code>@@</code>ï¼Œå‰å°å±•ç¤ºçš„æ—¶å€™ï¼Œ<code>@@</code> ç”±äºå­—ç¬¦ä¸²è¢«å»æ‰äº†ï¼Œä½†æ˜¯ nacos ä¸Šå­˜å–æœåŠ¡å®ä¾‹çš„ map ä¸­çš„åç§°ä¸­å®é™…ä¸Šå¸¦æœ‰æˆ‘æ·»åŠ çš„ <code>@@</code>ï¼Œåˆ é™¤çš„æ—¶å€™å°±å¤±è´¥äº†ï¼Œå› ä¸ºæ ¹æ®æœåŠ¡ name æŸ¥æ‰¾ä¸åˆ°ï¼ˆå®é™…çš„ name å¤šäº† <code>@@</code> åç¼€ï¼‰ã€‚</p>
<p>åå°ç•Œé¢ä¸Šå‡ºç°ä¸¤ä¸ªåŒåçš„æœåŠ¡çš„åŸå› ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªï¼Œåªæ˜¯æ˜¾ç¤ºçš„æœåŠ¡åç§°ç›¸åŒï¼Œå®é™…ä¸Šæ˜¯ä¸¤ä¸ªä¸åŒçš„æœåŠ¡ã€‚</p>
<p>ä¸ºä»€ä¹ˆ nacos åœ¨è¿”å› service çš„æ—¶å€™è¦å°†<code>@@</code> å»æ‰ï¼Œç”±å‰æ‰€è¿°å› ä¸º group å’Œ serviceNameï¼Œè¿”å›çš„æ—¶å€™è¦æŠŠåˆå¹¶çš„å­—ç¬¦ï¼Œè¿˜åŸå›å»ã€‚</p>
<p>éšåæŸ¥çœ‹äº†ä¸‹ nacos ä¸­æ˜¯æœ‰åšå­—ç¬¦æ£€æµ‹çš„ï¼Œä½†æ˜¯æ­£åˆ™å†™çš„æœ‰é—®é¢˜ã€‚ã€‚<br>
<code>com.alibaba.nacos.naming.core.Service#validate</code>ï¼Œ<br>
<code>com.alibaba.nacos.naming.core.Service#SERVICE_NAME_SYNTAX</code></p>
<pre><code class="language-java">    private static final String SERVICE_NAME_SYNTAX = &quot;[0-9a-zA-Z@\\.:_-]+&quot;;
</code></pre>
]]></content>
    </entry>
</feed>